{% extends "base.html" %}
{% block title %}{{ t('payments_edit_title', default='Edit Money Out') }} - FiCore{% endblock %}
{% block content %}
<div class="container mt-5">
    <div class="page-title">
        <h1>{{ t('payments_edit_title', default='Edit Money Out') }}</h1>
        <small class="subtext">{{ t('payments_subtitle', default='Ku…óin Da Ka Biya Wasu') }}</small>
    </div>
    {% if not can_interact %}
        <div class="alert alert-warning" role="alert">
            {{ t('payments_subscription_required', default='Your trial has expired or you do not have an active subscription. Please subscribe to edit payments.') }}
            <a href="{{ url_for('subscribe_bp.subscribe') }}" class="alert-link">{{ t('general_subscribe', default='Subscribe now') }}</a>
        </div>
    {% endif %}
    <form action="{{ url_for('payments.edit', id=payment._id) }}" method="POST" class="row g-3" {% if not can_interact %}onsubmit="return false;"{% endif %}>
        {{ form.hidden_tag() }}
        <div class="col-12">
            <label for="party_name" class="form-label">{{ t('payments_party_name', default='Party Name') }}</label>
            {{ form.party_name(class="form-control", required=True, disabled=not can_interact, **{"aria-required": "true"}) }}
            {% if form.party_name.errors %}
                <p class="text-danger mt-1">{{ form.party_name.errors[0] }}</p>
            {% endif %}
        </div>
        <div class="col-12">
            <label for="date" class="form-label">{{ t('general_date', default='Date') }}</label>
            {{ form.date(class="form-control", type="date", required=True, disabled=not can_interact, **{"aria-required": "true"}) }}
            {% if form.date.errors %}
                <p class="text-danger mt-1">{{ form.date.errors[0] }}</p>
            {% endif %}
        </div>
        <div class="col-12">
            <label for="amount" class="form-label">{{ t('general_amount', default='Amount') }}</label>
            {{ form.amount(class="form-control", type="number", step="0.01", required=True, disabled=not can_interact, **{"aria-required": "true"}) }}
            {% if form.amount.errors %}
                <p class="text-danger mt-1">{{ form.amount.errors[0] }}</p>
            {% endif %}
        </div>
        <div class="col-12">
            <label for="method" class="form-label">{{ t('payments_payment_method', default='Payment Method') }}</label>
            {{ form.method(class="form-control", disabled=not can_interact) }}
            {% if form.method.errors %}
                <p class="text-danger mt-1">{{ form.method.errors[0] }}</p>
            {% endif %}
        </div>
        <div class="col-12">
            <label for="expense_category" class="form-label">
                {{ t('general_expense_category', default='Expense Category') }} <span class="text-danger">*</span>
                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                   title="{{ t('expense_category_help', default='Select the category that best describes this expense for tax calculation purposes') }}"
                   aria-label="{{ t('expense_category_help', default='Select the category that best describes this expense for tax calculation purposes') }}"></i>
            </label>
            {{ form.expense_category(class="form-control", id="expense_category", required=True, disabled=not can_interact, 
                **{
                    "aria-label": t('payments_expense_category', default='Expense Category'),
                    "aria-describedby": "expense_category_help category-info",
                    "aria-required": "true",
                    "aria-invalid": "true" if form.expense_category.errors else "false"
                }) }}
            {% if form.expense_category.errors %}
                <div class="text-danger mt-1" role="alert" aria-live="polite" id="expense_category_error">
                    {{ form.expense_category.errors[0] }}
                </div>
            {% endif %}
            <div id="expense_category_help" class="form-text">
                {{ t('payments_category_tooltip', default='Choose the category that best describes this expense') }}
            </div>
            <div id="category-info" class="mt-2" style="display: none;" role="region" aria-labelledby="category-name" aria-live="polite">
                <div class="card border-info">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="card-title mb-0" id="category-name" tabindex="0"></h6>
                            <span id="tax-indicator" class="badge ms-2" role="status" aria-live="polite"></span>
                        </div>
                        <p class="card-text small mb-2" id="category-description" aria-describedby="category-name"></p>
                        <div class="small text-muted">
                            <strong>{{ t('category_examples', default='Examples') }}:</strong>
                            <span id="category-examples" aria-label="{{ t('category_examples', default='Examples') }}"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <label for="contact" class="form-label">{{ t('general_contact', default='Contact') }}</label>
            {{ form.contact(class="form-control", disabled=not can_interact) }}
            {% if form.contact.errors %}
                <p class="text-danger mt-1">{{ form.contact.errors[0] }}</p>
            {% endif %}
        </div>
        <div class="col-12">
            <label for="description" class="form-label">{{ t('general_description', default='Description') }}</label>
            {{ form.description(class="form-control", rows="3", disabled=not can_interact, **{"aria-describedby": "description_help"}) }}
            <div id="description_help" class="form-text">
                {{ t('general_description_help', default='Provide additional details about the payment (optional, max 1000 characters)') }}
            </div>
            {% if form.description.errors %}
                <p class="text-danger mt-1">{{ form.description.errors[0] }}</p>
            {% endif %}
        </div>
        <div class="col-12">
            <button type="submit" class="btn btn-primary w-100" {% if not can_interact %}disabled{% endif %}>{{ t('general_save', default='Save') }}</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl); });
    
    // Use Jinja2's tojson filter to safely serialize category data
    const categoryData = {{ expense_categories | tojson }};

    const categorySelect = document.getElementById('expense_category');
    const categoryInfo = document.getElementById('category-info');
    const categoryName = document.getElementById('category-name');
    const categoryDescription = document.getElementById('category-description');
    const categoryExamples = document.getElementById('category-examples');
    const taxIndicator = document.getElementById('tax-indicator');

    function updateCategoryInfo() {
        const selectedCategory = categorySelect.value;
        if (selectedCategory && categoryData[selectedCategory]) {
            const data = categoryData[selectedCategory];
            categoryName.textContent = data.name;
            categoryDescription.textContent = data.description;
            categoryExamples.textContent = data.examples.join(', ');
            taxIndicator.textContent = data.tax_deductible ? '{{ t("tax_deductible", default="Tax Deductible") }}' : '{{ t("not_tax_deductible", default="Not Tax Deductible") }}';
            taxIndicator.className = data.tax_deductible ? 'badge bg-success ms-2' : 'badge bg-warning text-dark ms-2';
            categoryInfo.querySelector('.card').className = data.is_personal ? 'card border-warning' : 'card border-info';
            categoryInfo.style.display = 'block';
        } else {
            categoryInfo.style.display = 'none';
        }
    }

    categorySelect.addEventListener('change', updateCategoryInfo);
    if (categorySelect.value) updateCategoryInfo();

    function getCsrfToken() {
        return document.querySelector('input[name="csrf_token"]').value;
    }

    function validateField(field, validator) {
        const errors = validator(field.value);
        const errorContainer = field.parentNode.querySelector('.validation-error');
        if (errorContainer) errorContainer.remove();
        if (errors.length > 0) {
            field.classList.add('is-invalid');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'validation-error text-danger mt-1 small';
            errorDiv.innerHTML = errors.map(error => `<div>${error}</div>`).join('');
            field.parentNode.appendChild(errorDiv);
        } else {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        }
        return errors.length === 0;
    }

    const partyNameField = document.getElementById('party_name');
    const dateField = document.getElementById('date');
    const amountField = document.getElementById('amount');
    const categoryField = document.getElementById('expense_category');
    const contactField = document.getElementById('contact');
    const descriptionField = document.getElementById('description');

    partyNameField.addEventListener('blur', () => validateField(partyNameField, value => {
        if (!value) return ['{{ t("validation_party_name_required", default="Recipient name is required") }}'];
        if (value.length < 2) return ['{{ t("validation_party_name_too_short", default="Recipient name must be at least 2 characters") }}'];
        if (value.length > 100) return ['{{ t("validation_party_name_too_long", default="Recipient name cannot exceed 100 characters") }}'];
        return [];
    }));

    dateField.addEventListener('change', () => validateField(dateField, value => {
        if (!value) return ['{{ t("validation_date_required", default="Date is required") }}'];
        const selectedDate = new Date(value);
        const today = new Date();
        const tenYearsAgo = new Date();
        tenYearsAgo.setFullYear(today.getFullYear() - 10);
        if (selectedDate > today) return ['{{ t("validation_date_future", default="Date cannot be in the future") }}'];
        if (selectedDate < tenYearsAgo) return ['{{ t("validation_date_too_old", default="Date cannot be more than 10 years ago") }}'];
        return [];
    }));

    amountField.addEventListener('blur', () => validateField(amountField, value => {
        if (!value) return ['{{ t("validation_amount_required", default="Amount is required") }}'];
        const amount = parseFloat(value);
        if (isNaN(amount)) return ['{{ t("validation_amount_invalid", default="Please enter a valid amount") }}'];
        if (amount <= 0) return ['{{ t("validation_amount_negative", default="Amount must be greater than zero") }}'];
        if (amount > 999999999.99) return ['{{ t("validation_amount_too_large", default="Amount is too large") }}'];
        const decimalPlaces = (value.toString().split('.')[1] || '').length;
        if (decimalPlaces > 2) return ['{{ t("validation_amount_decimals", default="Amount cannot have more than 2 decimal places") }}'];
        return [];
    }));

    categoryField.addEventListener('change', () => validateField(categoryField, value => {
        if (!value) return ['{{ t("validation_category_required", default="Please select an expense category") }}'];
        return [];
    }));

    contactField.addEventListener('blur', () => validateField(contactField, value => {
        if (value && value.length > 100) return ['{{ t("validation_contact_too_long", default="Contact cannot exceed 100 characters") }}'];
        return [];
    }));

    descriptionField.addEventListener('blur', () => validateField(descriptionField, value => {
        if (value && value.length > 1000) return ['{{ t("validation_description_too_long", default="Description cannot exceed 1000 characters") }}'];
        return [];
    }));

    document.querySelector('form').addEventListener('submit', e => {
        let hasErrors = false;
        if (!validateField(partyNameField, value => {
            if (!value) return ['{{ t("validation_party_name_required", default="Recipient name is required") }}'];
            if (value.length < 2) return ['{{ t("validation_party_name_too_short", default="Recipient name must be at least 2 characters") }}'];
            if (value.length > 100) return ['{{ t("validation_party_name_too_long", default="Recipient name cannot exceed 100 characters") }}'];
            return [];
        })) hasErrors = true;

        if (!validateField(dateField, value => {
            if (!value) return ['{{ t("validation_date_required", default="Date is required") }}'];
            const selectedDate = new Date(value);
            const today = new Date();
            const tenYearsAgo = new Date();
            tenYearsAgo.setFullYear(today.getFullYear() - 10);
            if (selectedDate > today) return ['{{ t("validation_date_future", default="Date cannot be in the future") }}'];
            if (selectedDate < tenYearsAgo) return ['{{ t("validation_date_too_old", default="Date cannot be more than 10 years ago") }}'];
            return [];
        })) hasErrors = true;

        if (!validateField(amountField, value => {
            if (!value) return ['{{ t("validation_amount_required", default="Amount is required") }}'];
            const amount = parseFloat(value);
            if (isNaN(amount)) return ['{{ t("validation_amount_invalid", default="Please enter a valid amount") }}'];
            if (amount <= 0) return ['{{ t("validation_amount_negative", default="Amount must be greater than zero") }}'];
            if (amount > 999999999.99) return ['{{ t("validation_amount_too_large", default="Amount is too large") }}'];
            const decimalPlaces = (value.toString().split('.')[1] || '').length;
            if (decimalPlaces > 2) return ['{{ t("validation_amount_decimals", default="Amount cannot have more than 2 decimal places") }}'];
            return [];
        })) hasErrors = true;

        if (!validateField(categoryField, value => {
            if (!value) return ['{{ t("validation_category_required", default="Please select an expense category") }}'];
            return [];
        })) hasErrors = true;

        if (!validateField(contactField, value => {
            if (value && value.length > 100) return ['{{ t("validation_contact_too_long", default="Contact cannot exceed 100 characters") }}'];
            return [];
        })) hasErrors = true;

        if (!validateField(descriptionField, value => {
            if (value && value.length > 1000) return ['{{ t("validation_description_too_long", default="Description cannot exceed 1000 characters") }}'];
            return [];
        })) hasErrors = true;

        if (hasErrors) {
            e.preventDefault();
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <strong>{{ t("validation_form_errors", default="Please correct the errors below:") }}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const existingAlert = document.querySelector('form').querySelector('.alert-danger');
            if (existingAlert) existingAlert.remove();
            document.querySelector('form').insertBefore(alertDiv, document.querySelector('form').firstChild);
            const firstError = document.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
    });
});
</script>
{% endblock %}
