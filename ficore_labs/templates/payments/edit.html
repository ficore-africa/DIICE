{% extends "base.html" %}
{% block title %}{{ t('payments_edit_title', default='Edit Money Out') }} - FiCore{% endblock %}
{% block content %}
<div class="container mt-5">
    <div class="page-title">
        <h1>{{ t('payments_edit_title', default='Edit Money Out') }}</h1>
        <small class="subtext">{{ t('payments_subtitle', default='Ku…óin Da Ka Biya Wasu') }}</small>
    </div>
    {% if not can_interact %}
        <div class="alert alert-warning" role="alert">
            {{ t('payments_subscription_required', default='Your trial has expired or you do not have an active subscription. Please subscribe to edit payments.') }}
            <a href="{{ url_for('general_bp.subscription_required') }}" class="alert-link">{{ t('general_subscribe', default='Subscribe now') }}</a>
        </div>
    {% endif %}
    <form action="{{ url_for('payments.edit', id=payment._id) }}" method="POST" class="row g-3" {% if not can_interact %}onsubmit="return false;"{% endif %}>
        {{ form.hidden_tag() }}
        <div class="col-12">
            <label for="party_name" class="form-label">{{ t('payments_party_name', default='Party Name') }}</label>
            {{ form.party_name(class="form-control", required=True, disabled=not can_interact) }}
            {% if form.party_name.errors %}
                <p class="text-danger mt-1">{{ form.party_name.errors[0] }}</p>
            {% endif %}
        </div>
        <div class="col-12">
            <label for="date" class="form-label">{{ t('general_date', default='Date') }}</label>
            {{ form.date(class="form-control", type="date", required=True, disabled=not can_interact) }}
            {% if form.date.errors %}
                <p class="text-danger mt-1">{{ form.date.errors[0] }}</p>
            {% endif %}
        </div>
        <div class="col-12">
            <label for="amount" class="form-label">{{ t('general_amount', default='Amount') }}</label>
            {{ form.amount(class="form-control", type="number", step="0.01", required=True, disabled=not can_interact) }}
            {% if form.amount.errors %}
                <p class="text-danger mt-1">{{ form.amount.errors[0] }}</p>
            {% endif %}
        </div>
        <div class="col-12">
            <label for="method" class="form-label">{{ t('payments_payment_method', default='Payment Method') }}</label>
            {{ form.method(class="form-control", disabled=not can_interact) }}
            {% if form.method.errors %}
                <p class="text-danger mt-1">{{ form.method.errors[0] }}</p>
            {% endif %}
        </div>
        <div class="col-12">
            <label for="expense_category" class="form-label">
                {{ t('general_expense_category', default='Expense Category') }} <span class="text-danger">*</span>
                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                   title="{{ t('expense_category_help', default='Select the category that best describes this expense for tax calculation purposes') }}"
                   aria-label="{{ t('expense_category_help', default='Select the category that best describes this expense for tax calculation purposes') }}"></i>
            </label>
            {{ form.expense_category(class="form-control", id="expense_category", required=True, disabled=not can_interact, 
                **{
                    "aria-label": t('payments_expense_category', default='Expense Category'),
                    "aria-describedby": "expense_category_help category-info",
                    "aria-required": "true",
                    "aria-invalid": "true" if form.expense_category.errors else "false"
                }) }}
            {% if form.expense_category.errors %}
                <div class="text-danger mt-1" role="alert" aria-live="polite" id="expense_category_error">
                    {{ form.expense_category.errors[0] }}
                </div>
            {% endif %}
            <div id="expense_category_help" class="form-text">
                {{ t('payments_category_tooltip', default='Choose the category that best describes this expense') }}
            </div>
            
            <!-- Category Information Display -->
            <div id="category-info" class="mt-2" style="display: none;">
                <div class="card border-info">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="card-title mb-0" id="category-name"></h6>
                            <span id="tax-indicator" class="badge ms-2"></span>
                        </div>
                        <p class="card-text small mb-2" id="category-description"></p>
                        <div class="small text-muted">
                            <strong>{{ t('category_examples', default='Examples') }}:</strong>
                            <span id="category-examples"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <label for="contact" class="form-label">{{ t('general_contact', default='Contact') }}</label>
            {{ form.contact(class="form-control", disabled=not can_interact) }}
            {% if form.contact.errors %}
                <p class="text-danger mt-1">{{ form.contact.errors[0] }}</p>
            {% endif %}
        </div>
        <div class="col-12">
            <label for="description" class="form-label">{{ t('general_description', default='Description') }}</label>
            {{ form.description(class="form-control", rows="3", disabled=not can_interact) }}
            {% if form.description.errors %}
                <p class="text-danger mt-1">{{ form.description.errors[0] }}</p>
            {% endif %}
        </div>
        <div class="col-12">
            <button type="submit" class="btn btn-primary w-100" {% if not can_interact %}disabled{% endif %}>{{ t('general_save', default='Save') }}</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Expense category data from backend
    const categoryData = {
        'office_admin': {
            'name': '{{ t("category_office_admin", default="Office & Admin") }}',
            'description': '{{ t("category_office_admin_desc", default="Office supplies, stationery, internet/data, utility bills") }}',
            'examples': ['{{ t("example_office_supplies", default="Office supplies") }}', '{{ t("example_stationery", default="Stationery") }}', '{{ t("example_internet", default="Internet/Data") }}', '{{ t("example_electricity", default="Electricity") }}'],
            'tax_deductible': true,
            'is_personal': false
        },
        'staff_wages': {
            'name': '{{ t("category_staff_wages", default="Staff & Wages") }}',
            'description': '{{ t("category_staff_wages_desc", default="Employee salaries, wages, and related costs") }}',
            'examples': ['{{ t("example_salaries", default="Salaries") }}', '{{ t("example_wages", default="Wages") }}', '{{ t("example_staff_benefits", default="Staff benefits") }}', '{{ t("example_payroll", default="Payroll costs") }}'],
            'tax_deductible': true,
            'is_personal': false
        },
        'business_travel': {
            'name': '{{ t("category_business_travel", default="Business Travel & Transport") }}',
            'description': '{{ t("category_business_travel_desc", default="Fuel, vehicle maintenance, and travel expenses for business") }}',
            'examples': ['{{ t("example_fuel", default="Fuel") }}', '{{ t("example_vehicle_maintenance", default="Vehicle maintenance") }}', '{{ t("example_business_travel", default="Business travel") }}', '{{ t("example_transport", default="Transport costs") }}'],
            'tax_deductible': true,
            'is_personal': false
        },
        'rent_utilities': {
            'name': '{{ t("category_rent_utilities", default="Rent & Utilities") }}',
            'description': '{{ t("category_rent_utilities_desc", default="Rent for shop or business office") }}',
            'examples': ['{{ t("example_shop_rent", default="Shop rent") }}', '{{ t("example_office_rent", default="Office rent") }}', '{{ t("example_business_premises", default="Business premises rent") }}'],
            'tax_deductible': true,
            'is_personal': false
        },
        'marketing_sales': {
            'name': '{{ t("category_marketing_sales", default="Marketing & Sales") }}',
            'description': '{{ t("category_marketing_sales_desc", default="Advertising, social media promotion, business cards") }}',
            'examples': ['{{ t("example_advertising", default="Advertising") }}', '{{ t("example_social_media", default="Social media promotion") }}', '{{ t("example_business_cards", default="Business cards") }}'],
            'tax_deductible': true,
            'is_personal': false
        },
        'cogs': {
            'name': '{{ t("category_cogs", default="Cost of Goods Sold (COGS)") }}',
            'description': '{{ t("category_cogs_desc", default="Direct costs of producing goods or services") }}',
            'examples': ['{{ t("example_raw_materials", default="Raw materials") }}', '{{ t("example_manufacturing", default="Manufacturing costs") }}', '{{ t("example_direct_labor", default="Direct labor") }}'],
            'tax_deductible': true,
            'is_personal': false
        },
        'personal_expenses': {
            'name': '{{ t("category_personal_expenses", default="Personal Expenses") }}',
            'description': '{{ t("category_personal_expenses_desc", default="Personal expenses not related to business") }}',
            'examples': ['{{ t("example_personal_meals", default="Personal meals") }}', '{{ t("example_personal_shopping", default="Personal shopping") }}', '{{ t("example_family_expenses", default="Family expenses") }}'],
            'tax_deductible': false,
            'is_personal': true
        },
        'statutory_legal': {
            'name': '{{ t("category_statutory_legal", default="Statutory & Legal Contributions") }}',
            'description': '{{ t("category_statutory_legal_desc", default="Accounting, legal, and consulting fees directly related to business") }}',
            'examples': ['{{ t("example_accounting_fees", default="Accounting fees") }}', '{{ t("example_legal_fees", default="Legal fees") }}', '{{ t("example_consulting_fees", default="Consulting fees") }}'],
            'tax_deductible': true,
            'is_personal': false
        }
    };
    
    const categorySelect = document.getElementById('expense_category');
    const categoryInfo = document.getElementById('category-info');
    const categoryName = document.getElementById('category-name');
    const categoryDescription = document.getElementById('category-description');
    const categoryExamples = document.getElementById('category-examples');
    const taxIndicator = document.getElementById('tax-indicator');
    
    function updateCategoryInfo() {
        const selectedCategory = categorySelect.value;
        
        if (selectedCategory && categoryData[selectedCategory]) {
            const data = categoryData[selectedCategory];
            
            categoryName.textContent = data.name;
            categoryDescription.textContent = data.description;
            categoryExamples.textContent = data.examples.join(', ');
            
            // Update tax indicator
            if (data.tax_deductible) {
                taxIndicator.textContent = '{{ t("tax_deductible", default="Tax Deductible") }}';
                taxIndicator.className = 'badge bg-success ms-2';
            } else {
                taxIndicator.textContent = '{{ t("not_tax_deductible", default="Not Tax Deductible") }}';
                taxIndicator.className = 'badge bg-warning text-dark ms-2';
            }
            
            // Show warning for personal expenses
            if (data.is_personal) {
                categoryInfo.querySelector('.card').className = 'card border-warning';
            } else {
                categoryInfo.querySelector('.card').className = 'card border-info';
            }
            
            categoryInfo.style.display = 'block';
        } else {
            categoryInfo.style.display = 'none';
        }
    }
    
    // Update category info when selection changes
    categorySelect.addEventListener('change', updateCategoryInfo);
    
    // Update on page load if there's a pre-selected value
    if (categorySelect.value) {
        updateCategoryInfo();
    }
});
</script>
{% endblock %}
