{% extends "base.html" %}
{% block title %}{{ t('payments_title', default='Money Out') }} - FiCore{% endblock %}
{% block content %}
<div class="container mt-5">
    <!-- Back Button -->
    <div class="d-flex align-items-center mb-4">
        <button onclick="history.back()" class="btn btn-outline-secondary me-3" aria-label="{{ t('general_back', default='Back') | e }}">
            <i class="bi bi-arrow-left"></i> {{ t('general_back', default='Back') | e }}
        </button>
        <a href="{{ url_for('dashboard.index') | e }}" class="btn btn-link text-decoration-none">
            <i class="bi bi-house"></i> {{ t('general_back_to_home', default='Back to Home') | e }}
        </a>
    </div>
    
    <div class="page-title">
        <h1>{{ t('payments_title', default='Money Out') | e }}</h1>
        <small class="subtext">{{ t('payments_subtitle', default='Ku…óin Da Ka Biya Wasu') | e }}</small>
    </div>
    <div class="mb-4">
        {% if can_interact %}
            <a href="{{ url_for('payments.add') | e }}" class="btn btn-secondary">{{ t('payments_add_title', default='Add Money Out') | e }}</a>
        {% else %}
            <a href="{{ url_for('subscribe_bp.subscribe') | e }}" class="btn btn-secondary">{{ t('payments_add_title', default='Add Money Out') | e }}</a>
        {% endif %}
        <a href="{{ url_for('payments.manage') | e }}" class="btn btn-primary">{{ t('payments_manage', default='Manage Payments') | e }}</a>
    </div>
    {% if payments_warning %}
        <div class="alert alert-warning" role="alert">
            {{ t('payments_skipped_warning', default='Some payment records could not be loaded due to data errors and were skipped.') | e }}
            {% if payments_skipped > 0 %}
                <br>
                <small>{{ payments_skipped }} record(s) skipped. IDs: {{ payments_skipped_ids|join(', ') }}</small>
            {% endif %}
        </div>
    {% endif %}
    
    {% if payments|length > 0 %}
        <!-- Category Filter and Summary Statistics -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">{{ t('general_filter_by_category', default='Filter by Category') | e }}</h6>
                        <select id="categoryFilter" class="form-select"
                                aria-label="{{ t('general_filter_by_category', default='Filter by Category') | e }}"
                                aria-describedby="category-filter-help">
                            <option value="">{{ t('general_all_categories', default='All Categories') | e }}</option>
                            <option value="office_admin">{{ t('category_office_admin', default='Office and Admin') | e }}</option>
                            <option value="staff_wages">{{ t('category_staff_wages', default='Staff and Wages') | e }}</option>
                            <option value="business_travel">{{ t('category_business_travel', default='Business Travel and Transport') | e }}</option>
                            <option value="rent_utilities">{{ t('category_rent_utilities', default='Rent and Utilities') | e }}</option>
                            <option value="marketing_sales">{{ t('category_marketing_sales', default='Marketing and Sales') | e }}</option>
                            <option value="cogs">{{ t('category_cogs', default='Cost of Goods Sold') | e }}</option>
                            <option value="personal_expenses">{{ t('category_personal_expenses', default='Personal Expenses') | e }}</option>
                            <option value="statutory_contributions">{{ t('category_statutory_contributions', default='Statutory and Legal Contributions') | e }}</option>
                        </select>
                        <small id="category-filter-help" class="form-text text-muted">
                            {{ t('general_filter_by_category_help', default='Select a category to filter payments') | e }}
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">{{ t('general_summary', default='Summary') | e }}</h6>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">{{ t('general_total_payments', default='Total Payments') | e }}</small>
                                <div class="fw-bold" id="totalPayments">{{ payments|length }}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">{{ t('general_total_amount', default='Total Amount') | e }}</small>
                                <div class="fw-bold" id="totalAmount">
                                    {% set total = payments | sum(attribute='amount') %}
                                    {{ format_currency(total) | e }}
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">{{ t('general_tax_deductible', default='Tax Deductible') | e }}</small>
                                <div class="fw-bold text-success" id="taxDeductibleAmount">
                                    {% set deductible_total = payments | selectattr('is_tax_deductible', 'equalto', true) | sum(attribute='amount') %}
                                    {{ format_currency(deductible_total) | e }}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">{{ t('general_non_deductible', default='Non-Deductible') | e }}</small>
                                <div class="fw-bold text-warning" id="nonDeductibleAmount">
                                    {% set non_deductible_total = payments | selectattr('is_tax_deductible', 'equalto', false) | sum(attribute='amount') %}
                                    {{ format_currency(non_deductible_total) | e }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    {% if payments|length > 0 %}
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="paymentsTable">
                <thead class="table-dark">
                    <tr>
                        <th>{{ t('payments_party_name', default='Party Name') | e }}</th>
                        <th>{{ t('general_amount', default='Amount') | e }}</th>
                        <th>{{ t('general_date', default='Date') | e }}</th>
                        <th>{{ t('payments_payment_method', default='Payment Method') | e }}</th>
                        <th>{{ t('general_category', default='Category') | e }}</th>
                        <th>{{ t('general_actions', default='Actions') | e }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                        <tr>
                            <td data-label="{{ t('payments_party_name', default='Party Name') | e }}">{{ payment.party_name | e }}</td>
                            <td data-label="{{ t('general_amount', default='Amount') | e }}">{{ format_currency(payment.amount) | e }}</td>
                            <td data-label="{{ t('general_date', default='Date') | e }}">{{ format_date(payment.created_at) | e }}</td>
                            <td data-label="{{ t('payments_payment_method', default='Payment Method') | e }}">{{ payment.method or '-' | e }}</td>
                            <td data-label="{{ t('general_category', default='Category') | e }}">
                                {% if payment.category_metadata and payment.category_metadata.category_display_name %}
                                    {{ payment.category_metadata.category_display_name | e }}
                                    {% if payment.category_metadata.is_personal %}
                                        <span class="badge bg-warning text-dark ms-1">{{ t('not_tax_deductible', default='Not Tax Deductible') | e }}</span>
                                    {% endif %}
                                {% elif payment.expense_category %}
                                    {{ payment.expense_category | title | e }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td data-label="{{ t('general_actions', default='Actions') | e }}">
                                <button class="btn btn-secondary btn-sm actions-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#actionsModal"
                                        data-id="{{ payment._id | e }}"
                                        data-name="{{ payment.party_name | e }}"
                                        data-amount="{{ payment.amount }}"
                                        data-date="{{ format_date(payment.created_at) | e }}"
                                        data-method="{{ payment.method or '' | e }}"
                                        data-category="{% if payment.category_metadata and payment.category_metadata.category_display_name %}{{ payment.category_metadata.category_display_name | e }}{% elif payment.expense_category %}{{ payment.expense_category | title | e }}{% endif %}"
                                        data-description="{{ payment.description or '' | e }}"
                                        data-contact="{{ payment.contact or '' | e }}">
                                    {{ t('general_actions', default='Actions') | e }}
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="text-center py-5">
            <p class="text-muted">{{ t('payments_no_records', default='No money out recorded') | e }}</p>
            <p class="mt-2">{{ t('payments_add_first', default='Start by logging your first money out.') | e }}</p>
        </div>
    {% endif %}
</div>

<div class="modal fade" id="actionsModal" tabindex="-1" aria-labelledby="actionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionsModalLabel">{{ t('payments_payment_details', default='Payment Details') | e }}</h5>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') | e }}"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>{{ t('payments_party_name', default='Party Name') | e }}:</strong> <span id="modalName"></span></p>
                        <p><strong>{{ t('general_amount', default='Amount') | e }}:</strong> <span id="modalAmount"></span></p>
                        <p><strong>{{ t('payments_payment_method', default='Payment Method') | e }}:</strong> <span id="modalMethod"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{{ t('general_category', default='Category') | e }}:</strong> <span id="modalCategory"></span></p>
                        <p><strong>{{ t('general_date', default='Date') | e }}:</strong> <span id="modalDate"></span></p>
                        <p><strong>{{ t('general_description', default='Description') | e }}:</strong> <span id="modalDescription"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="viewBtn" class="btn btn-primary" href="#">{{ t('general_view', default='View') | e }}</a>
                {% if can_interact %}
                    <a id="downloadBtn" class="btn btn-primary" href="#">{{ t('payments_download_receipt', default='Download Receipt') | e }}</a>
                    <button id="shareBtn" class="btn btn-primary" style="display: none;">{{ t('payments_share_receipt', default='Share Receipt') | e }}</button>
                {% else %}
                    <a id="downloadBtn" class="btn btn-primary disabled" href="{{ url_for('subscribe_bp.subscribe') | e }}">{{ t('payments_download_receipt', default='Download Receipt') | e }}</a>
                    <button id="shareBtn" class="btn btn-primary disabled" style="display: none;" onclick="alert('{{ t('payments_subscription_required', default='Your trial has expired or you do not have an active subscription. Please subscribe to share payments.') | e }}')">{{ t('payments_share_receipt', default='Share Receipt') | e }}</button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_close', default='Close') | e }}</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">{{ t('payments_share_receipt', default='Share Receipt') | e }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') | e }}"></button>
            </div>
            <div class="modal-body">
                {% if not can_interact %}
                    <div class="alert alert-warning" role="alert">
                        {{ t('payments_subscription_required', default='Your trial has expired or you do not have an active subscription. Please subscribe to share payments.') | e }}
                        <a href="{{ url_for('subscribe_bp.subscribe') | e }}" class="alert-link">{{ t('general_subscribe', default='Subscribe now') | e }}</a>
                    </div>
                {% endif %}
                <form id="shareForm" {% if not can_interact %}onsubmit="return false;"{% endif %}>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() | e }}">
                    <div class="mb-3">
                        <label for="shareType" class="form-label">{{ t('payments_share_type', default='Share Type') | e }}</label>
                        <select class="form-select" id="shareType" required {% if not can_interact %}disabled{% endif %}
                                aria-label="{{ t('payments_share_type', default='Share Type') | e }}">
                            <option value="sms">{{ t('general_sms', default='SMS') | e }}</option>
                            <option value="whatsapp">{{ t('general_whatsapp', default='WhatsApp') | e }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="shareMessage" class="form-label">{{ t('general_message', default='Message') | e }}</label>
                        <textarea class="form-control" id="shareMessage" rows="4" required {% if not can_interact %}disabled{% endif %}
                                  aria-label="{{ t('general_message', default='Message') | e }}"></textarea>
                        <div id="shareMessageError" class="invalid-feedback"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="sendShareBtn" {% if not can_interact %}disabled{% endif %}>{{ t('payments_share_receipt', default='Share Receipt') | e }}</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_cancel', default='Cancel') | e }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<style>
.modal-footer .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: clamp(0.875rem, 2vw, 0.9375rem);
    box-shadow: var(--card-shadow);
    transition: var(--transition-base);
}
.modal-footer.two-buttons .btn:first-child:not([data-bs-dismiss="modal"]) {
    background: var(--button-primary-bg);
    color: #ffffff;
    border: none;
}
.modal-footer.two-buttons .btn:first-child:not([data-bs-dismiss="modal"]):hover,
.modal-footer.two-buttons .btn:first-child:not([data-bs-dismiss="modal"]):focus {
    background: var(--button-primary-hover);
    transform: translateY(-2px);
    box-shadow: var(--card-shadow-hover);
}
.modal-footer.two-buttons .btn:last-child {
    background: var(--button-secondary-bg);
    color: var(--button-secondary-border);
    border: 2px solid var(--button-secondary-border);
}
.modal-footer.two-buttons .btn:last-child:hover,
.modal-footer.two-buttons .btn:last-child:focus {
    background: var(--button-secondary-hover);
    color: var(--text-color);
    transform: translateY(-2px);
}
.invalid-feedback {
    display: none;
    color: #dc3545;
    font-size: 0.875rem;
}
.was-validated .form-control:invalid ~ .invalid-feedback {
    display: block;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

    let currentPaymentData = null;
    
    // Category filtering functionality
    const categoryFilter = document.getElementById('categoryFilter');
    const paymentsTable = document.getElementById('paymentsTable');
    
    if (categoryFilter && paymentsTable) {
        categoryFilter.addEventListener('change', function() {
            const selectedCategory = this.value;
            const rows = paymentsTable.querySelectorAll('tbody tr');
            let visibleCount = 0;
            let visibleTotal = 0;
            let visibleDeductible = 0;
            let visibleNonDeductible = 0;
            
            rows.forEach(row => {
                const categoryCell = row.querySelector('td[data-label="{{ t(\'general_category\', default=\'Category\') | e }}"]');
                const amountCell = row.querySelector('td[data-label="{{ t(\'general_amount\', default=\'Amount\') | e }}"]');
                const actionBtn = row.querySelector('.actions-btn');
                
                if (categoryCell && amountCell && actionBtn) {
                    const categoryText = categoryCell.textContent.trim();
                    const amount = parseFloat(actionBtn.dataset.amount) || 0;
                    const categoryKey = getCategoryKeyFromText(categoryText);
                    const isDeductible = !categoryCell.querySelector('.badge.bg-warning');
                    
                    const shouldShow = !selectedCategory || categoryKey === selectedCategory;
                    
                    if (shouldShow) {
                        row.style.display = '';
                        visibleCount++;
                        visibleTotal += amount;
                        if (isDeductible) {
                            visibleDeductible += amount;
                        } else {
                            visibleNonDeductible += amount;
                        }
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
            
            // Update summary statistics
            updateSummaryStats(visibleCount, visibleTotal, visibleDeductible, visibleNonDeductible);
        });
    }
    
    function getCategoryKeyFromText(categoryText) {
        const categoryMap = {{ expense_categories | tojson }};
        
        // Remove badge text and trim
        const cleanText = categoryText.replace(/Not Tax Deductible/g, '').trim();
        for (const [key, value] of Object.entries(categoryMap)) {
            if (value.name === cleanText) {
                return key;
            }
        }
        return '';
    }
    
    function updateSummaryStats(count, total, deductible, nonDeductible) {
        const totalPaymentsEl = document.getElementById('totalPayments');
        const totalAmountEl = document.getElementById('totalAmount');
        const taxDeductibleAmountEl = document.getElementById('taxDeductibleAmount');
        const nonDeductibleAmountEl = document.getElementById('nonDeductibleAmount');
        
        if (totalPaymentsEl) totalPaymentsEl.textContent = count;
        if (totalAmountEl) totalAmountEl.textContent = formatCurrency(total);
        if (taxDeductibleAmountEl) taxDeductibleAmountEl.textContent = formatCurrency(deductible);
        if (nonDeductibleAmountEl) nonDeductibleAmountEl.textContent = formatCurrency(nonDeductible);
    }
    
    function formatCurrency(amount) {
        return amount.toLocaleString('en-NG', {
            style: 'currency',
            currency: '{{ t("general_currency_code", default="NGN") | e }}',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function getCsrfToken() {
        const tokenInput = document.querySelector('input[name="csrf_token"]');
        return tokenInput ? tokenInput.value : '';
    }

    function updateModalButtonClasses() {
        const modalFooter = document.querySelector('#actionsModal .modal-footer');
        const visibleButtons = Array.from(modalFooter.querySelectorAll('.btn')).filter(btn => btn.style.display !== 'none');
        
        modalFooter.classList.remove('two-buttons');
        if (visibleButtons.length === 2) {
            modalFooter.classList.add('two-buttons');
            visibleButtons.forEach((btn, index) => {
                if (index === 0 && !btn.dataset.bsDismiss) {
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-primary');
                } else if (btn.dataset.bsDismiss) {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                }
            });
        } else {
            const viewBtn = document.getElementById('viewBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const shareBtn = document.getElementById('shareBtn');
            const closeBtn = modalFooter.querySelector('[data-bs-dismiss="modal"]');
            [viewBtn, downloadBtn, shareBtn].forEach(btn => {
                if (btn) {
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-primary');
                }
            });
            if (closeBtn) {
                closeBtn.classList.remove('btn-primary');
                closeBtn.classList.add('btn-secondary');
            }
        }
    }

    document.querySelectorAll('.actions-btn').forEach(button => {
        button.addEventListener('click', () => {
            console.log('Actions button clicked:', button.dataset.id);
            currentPaymentData = {
                _id: button.dataset.id,
                name: button.dataset.name,
                amount: parseFloat(button.dataset.amount),
                date: button.dataset.date,
                method: button.dataset.method,
                category: button.dataset.category,
                description: button.dataset.description,
                contact: button.dataset.contact
            };

            document.getElementById('modalName').textContent = currentPaymentData.name;
            document.getElementById('modalAmount').textContent = formatCurrency(currentPaymentData.amount);
            document.getElementById('modalMethod').textContent = currentPaymentData.method || '-';
            document.getElementById('modalCategory').textContent = currentPaymentData.category || '-';
            document.getElementById('modalDate').textContent = currentPaymentData.date;
            document.getElementById('modalDescription').textContent = currentPaymentData.description || '-';

            document.getElementById('viewBtn').href = `/payments/view/${currentPaymentData._id}`;
            document.getElementById('downloadBtn').href = `/payments/generate_pdf/${currentPaymentData._id}`;
            document.getElementById('shareBtn').style.display = currentPaymentData.contact ? 'inline-block' : 'none';

            updateModalButtonClasses();
        });
    });

    document.getElementById('shareBtn').addEventListener('click', () => {
        if (!currentPaymentData) {
            console.error('No payment data available');
            return;
        }
        const defaultMessage = `Payment from FiCore Records\nRecipient: ${currentPaymentData.name}\nAmount: ${formatCurrency(currentPaymentData.amount)}\nDate: ${currentPaymentData.date}\nPayment ID: ${currentPaymentData._id}`;
        document.getElementById('shareMessage').value = defaultMessage;
        new bootstrap.Modal(document.getElementById('shareModal')).show();
    });

    document.getElementById('sendShareBtn').addEventListener('click', function() {
        if (!currentPaymentData) {
            console.error('No payment data available');
            return;
        }
        
        const shareForm = document.getElementById('shareForm');
        const shareType = document.getElementById('shareType');
        const shareMessage = document.getElementById('shareMessage');
        const shareMessageError = document.getElementById('shareMessageError');
        
        // Reset validation state
        shareForm.classList.remove('was-validated');
        shareMessageError.textContent = '';
        
        // Validate form
        if (!shareForm.checkValidity()) {
            shareForm.classList.add('was-validated');
            if (!shareMessage.value.trim()) {
                shareMessageError.textContent = '{{ t("general_message_required", default="Message is required") | e }}';
            }
            return;
        }
        
        this.disabled = true;
        this.textContent = '{{ t("general_sending", default="Sending...") | e }}';
        
        fetch('/payments/share', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                paymentId: currentPaymentData._id,
                recipient: currentPaymentData.contact,
                message: shareMessage.value,
                type: shareType.value
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('{{ t("payments_share_success", default="Payment shared successfully") | e }}');
                bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
                bootstrap.Modal.getInstance(document.getElementById('actionsModal')).hide();
            } else {
                alert('{{ t("payments_share_failed", default="Failed to share payment") | e }}: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error sharing payment:', error);
            alert('{{ t("payments_share_error", default="Error sharing payment") | e }}: ' + error.message);
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = '{{ t("payments_share_receipt", default="Share Receipt") | e }}';
        });
    });
});
</script>
{% endblock %}
