{% extends "base.html" %}
{% block title %}{{ t('payments_manage', default='Manage Payments') | e }} - FiCore{% endblock %}
{% block content %}
<div class="container mt-5">
    <div class="page-title">
        <h1>{{ t('payments_manage', default='Manage Payments') | e }}</h1>
        <small class="subtext">{{ t('payments_subtitle', default='Ku…óin Da Ka Biya Wasu') | e }}</small>
    </div>
    <div class="mb-4">
        <a href="{{ url_for('payments.index') | e }}" class="btn btn-secondary">{{ t('general_back', default='Back') | e }}</a>
        {% if can_interact %}
            <a href="{{ url_for('payments.add') | e }}" class="btn btn-primary">{{ t('payments_add_title', default='Add Money Out') | e }}</a>
        {% else %}
            <a href="{{ url_for('subscribe_bp.subscribe') | e }}" class="btn btn-primary">{{ t('payments_add_title', default='Add Money Out') | e }}</a>
        {% endif %}
    </div>
    {% if payments|length > 0 %}
        <div class="row mb-4">
            <div class="col-md-6">
                <input type="text" id="searchInput" class="form-control" 
                       placeholder="{{ t('general_search', default='Search payments...') | e }}"
                       aria-label="{{ t('general_search', default='Search payments') | e }}"
                       aria-describedby="search-help">
                <div id="search-help" class="form-text">
                    {{ t('general_search_help', default='Search by recipient name or category') | e }}
                </div>
            </div>
            <div class="col-md-6">
                <select id="categoryFilter" class="form-select" 
                        aria-label="{{ t('general_filter_by_category', default='Filter by Category') | e }}"
                        aria-describedby="category-filter-help">
                    <option value="">{{ t('general_all_categories', default='All Categories') | e }}</option>
                    <option value="office_admin">{{ t('category_office_admin', default='Office and Admin') | e }}</option>
                    <option value="staff_wages">{{ t('category_staff_wages', default='Staff and Wages') | e }}</option>
                    <option value="business_travel">{{ t('category_business_travel', default='Business Travel and Transport') | e }}</option>
                    <option value="rent_utilities">{{ t('category_rent_utilities', default='Rent and Utilities') | e }}</option>
                    <option value="marketing_sales">{{ t('category_marketing_sales', default='Marketing and Sales') | e }}</option>
                    <option value="cogs">{{ t('category_cogs', default='Cost of Goods Sold') | e }}</option>
                    <option value="personal_expenses">{{ t('category_personal_expenses', default='Personal Expenses') | e }}</option>
                    <option value="statutory_contributions">{{ t('category_statutory_contributions', default='Statutory and Legal Contributions') | e }}</option>
                </select>
                <div id="category-filter-help" class="form-text">
                    {{ t('general_filter_by_category_help', default='Filter payments by expense category') | e }}
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">{{ t('general_summary', default='Summary') | e }}</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">{{ t('general_total_payments', default='Total Payments') | e }}</small>
                                <div class="fw-bold" id="totalPayments">{{ payments|length }}</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">{{ t('general_total_amount', default='Total Amount') | e }}</small>
                                <div class="fw-bold" id="totalAmount">
                                    {% set total = payments | sum(attribute='amount') %}
                                    {{ format_currency(total) | e }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">{{ t('general_tax_deductible', default='Tax Deductible') | e }}</small>
                                <div class="fw-bold text-success" id="taxDeductibleAmount">
                                    {% set deductible_total = payments | selectattr('is_tax_deductible', 'equalto', true) | sum(attribute='amount') %}
                                    {{ format_currency(deductible_total) | e }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">{{ t('general_non_deductible', default='Non-Deductible') | e }}</small>
                                <div class="fw-bold text-warning" id="nonDeductibleAmount">
                                    {% set non_deductible_total = payments | selectattr('is_tax_deductible', 'equalto', false) | sum(attribute='amount') %}
                                    {{ format_currency(non_deductible_total) | e }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="paymentsTable">
                <thead class="table-dark">
                    <tr>
                        <th>{{ t('payments_party_name', default='Party Name') | e }}</th>
                        <th>{{ t('general_amount', default='Amount') | e }}</th>
                        <th>{{ t('general_date', default='Date') | e }}</th>
                        <th>{{ t('payments_payment_method', default='Payment Method') | e }}</th>
                        <th>{{ t('general_category', default='Category') | e }}</th>
                        <th>{{ t('general_actions', default='Actions') | e }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                        <tr>
                            <td data-label="{{ t('payments_party_name', default='Party Name') | e }}">{{ payment.party_name | e }}</td>
                            <td data-label="{{ t('general_amount', default='Amount') | e }}">{{ format_currency(payment.amount) | e }}</td>
                            <td data-label="{{ t('general_date', default='Date') | e }}">{{ format_date(payment.created_at) | e }}</td>
                            <td data-label="{{ t('payments_payment_method', default='Payment Method') | e }}">{{ payment.method or '-' | e }}</td>
                            <td data-label="{{ t('general_category', default='Category') | e }}">
                                {% if payment.category_metadata and payment.category_metadata.category_display_name %}
                                    {{ payment.category_metadata.category_display_name | e }}
                                    {% if payment.category_metadata.is_personal %}
                                        <span class="badge bg-warning text-dark ms-1">{{ t('not_tax_deductible', default='Not Tax Deductible') | e }}</span>
                                    {% endif %}
                                {% elif payment.expense_category %}
                                    {{ payment.expense_category | title | e }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td data-label="{{ t('general_actions', default='Actions') | e }}">
                                {% if can_interact %}
                                    <a href="{{ url_for('payments.edit', id=payment._id) | e }}" 
                                       class="btn btn-primary btn-sm"
                                       data-bs-toggle="tooltip" 
                                       title="{{ t('general_edit', default='Edit') | e }}">
                                        {{ t('general_edit', default='Edit') | e }}
                                    </a>
                                    <form action="{{ url_for('payments.delete', id=payment._id) | e }}" method="POST" class="d-inline">
                                        {{ form.hidden_tag() }}
                                        <button type="submit" class="btn btn-danger btn-sm" 
                                                onclick="return confirm('{{ t('general_confirm_delete', default='Are you sure?') | e }}')"
                                                data-bs-toggle="tooltip" 
                                                title="{{ t('general_delete', default='Delete') | e }}"
                                                aria-label="{{ t('general_delete', default='Delete') | e }}">
                                            {{ t('general_delete', default='Delete') | e }}
                                        </button>
                                    </form>
                                {% else %}
                                    <a href="{{ url_for('subscribe_bp.subscribe') | e }}" 
                                       class="btn btn-primary btn-sm disabled"
                                       data-bs-toggle="tooltip" 
                                       title="{{ t('general_edit', default='Edit') | e }}">
                                        {{ t('general_edit', default='Edit') | e }}
                                    </a>
                                    <button class="btn btn-danger btn-sm disabled" 
                                            data-bs-toggle="tooltip" 
                                            title="{{ t('general_delete', default='Delete') | e }}"
                                            onclick="alert('{{ t('payments_subscription_required', default='Your trial has expired or you do not have an active subscription. Please subscribe to delete payments.') | e }}')"
                                            aria-label="{{ t('general_delete', default='Delete') | e }}">
                                        {{ t('general_delete', default='Delete') | e }}
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="text-center py-5">
            <p class="text-muted">{{ t('payments_no_records', default='No money out recorded') | e }}</p>
            <p class="mt-2">{{ t('payments_add_first', default='Start by logging your first money out.') | e }}</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const table = document.getElementById('paymentsTable');
    const rows = Array.from(table.getElementsByTagName('tr')).slice(1);

    function filterRows() {
        const searchFilter = searchInput.value.toLowerCase();
        const selectedCategory = categoryFilter.value;
        let visibleCount = 0;
        let visibleTotal = 0;
        let visibleDeductible = 0;
        let visibleNonDeductible = 0;

        rows.forEach(row => {
            const cells = row.getElementsByTagName('td');
            const categoryCell = cells[4];
            const amountCell = cells[1];
            
            let searchMatch = !searchFilter;
            if (searchFilter) {
                for (let j = 0; j < cells.length - 1; j++) {
                    if (cells[j].textContent.toLowerCase().includes(searchFilter)) {
                        searchMatch = true;
                        break;
                    }
                }
            }
            
            let categoryMatch = !selectedCategory;
            if (selectedCategory && categoryCell) {
                const categoryText = categoryCell.textContent.trim();
                const categoryKey = getCategoryKeyFromText(categoryText);
                categoryMatch = categoryKey === selectedCategory;
            }
            
            const shouldShow = searchMatch && categoryMatch;
            
            if (shouldShow) {
                row.style.display = '';
                visibleCount++;
                const amountText = amountCell.textContent.replace(/[‚Ç¶,]/g, '');
                const amount = parseFloat(amountText) || 0;
                visibleTotal += amount;
                const isDeductible = !categoryCell.querySelector('.badge.bg-warning');
                if (isDeductible) {
                    visibleDeductible += amount;
                } else {
                    visibleNonDeductible += amount;
                }
            } else {
                row.style.display = 'none';
            }
        });
        
        updateSummaryStats(visibleCount, visibleTotal, visibleDeductible, visibleNonDeductible);
    }

    function getCategoryKeyFromText(categoryText) {
        const categoryMap = {{ expense_categories | tojson }};
        const cleanText = categoryText.replace(/Not Tax Deductible/g, '').trim();
        for (const [key, value] of Object.entries(categoryMap)) {
            if (value.name === cleanText) {
                return key;
            }
        }
        return '';
    }
    
    function updateSummaryStats(count, total, deductible, nonDeductible) {
        const totalPaymentsEl = document.getElementById('totalPayments');
        const totalAmountEl = document.getElementById('totalAmount');
        const taxDeductibleAmountEl = document.getElementById('taxDeductibleAmount');
        const nonDeductibleAmountEl = document.getElementById('nonDeductibleAmount');
        
        if (totalPaymentsEl) totalPaymentsEl.textContent = count;
        if (totalAmountEl) totalAmountEl.textContent = formatCurrency(total);
        if (taxDeductibleAmountEl) taxDeductibleAmountEl.textContent = formatCurrency(deductible);
        if (nonDeductibleAmountEl) nonDeductibleAmountEl.textContent = formatCurrency(nonDeductible);
    }
    
    function formatCurrency(amount) {
        return amount.toLocaleString('en-NG', {
            style: 'currency',
            currency: '{{ t("general_currency_code", default="NGN") | e }}',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    searchInput.addEventListener('input', filterRows);
    categoryFilter.addEventListener('change', filterRows);
});
</script>
{% endblock %}
