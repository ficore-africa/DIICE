{% extends "base.html" %}

{% block title %}{{ t('tax_calculator_title', default='Tax Calculator') | e }} - DIICE{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/tax-calculator-realtime.js') }}" defer></script>
<style>
    .category-totals .card {
        transition: all 0.3s ease;
    }

    .category-totals .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .tax-modal-content .modal-step-card {
        margin-bottom: 1rem;
    }

    .tax-modal-content .card-header {
        padding: 0.5rem 1rem;
    }

    .tax-modal-content .card-body {
        padding: 0.75rem 1rem;
    }

    .final-summary-table .table td {
        padding: 0.5rem;
    }

    .four-step-modal-breakdown .card {
        margin-bottom: 0.75rem;
    }

    @media print {

        .modal-header,
        .modal-footer {
            display: none !important;
        }

        .modal-dialog {
            margin: 0;
            max-width: 100%;
        }

        .modal-content {
            border: none;
            box-shadow: none;
        }
    }

    /* Real-time update animations */
    #deductibleTotal,
    #statutoryTotal,
    #personalTotal {
        transition: all 0.3s ease;
    }

    .updating {
        color: #ffc107 !important;
        transform: scale(1.05);
    }

    /* Input feedback animations */
    .expense-input.updating {
        border-color: #ffc107;
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
    }

    /* Tax summary animations */
    .tax-summary-content {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Metric items styling */
    .metric-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .metric-item:last-child {
        border-bottom: none;
    }

    .metric-label {
        font-size: 0.9rem;
    }

    .metric-value {
        font-weight: 600;
    }

    /* Sticky tax summary */
    .sticky-top {
        top: 20px;
    }

    /* Loading spinner for real-time calculations */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h1 class="page-title">{{ t('tax_calculator_title', default='Tax Calculator') | e }}</h1>
                <p class="page-subtitle">{{ t('tax_calculator_subtitle', default='Calculate your tax liability based on
                    Nigeria Tax Act 2025') | e }}</p>

                <!-- Entity Type Display -->
                <div class="entity-type-info mt-3">
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="fas fa-building me-3"></i>
                        <div class="flex-grow-1">
                            <strong>{{ t('business_entity_type', default='Business Entity Type') | e }}:</strong>
                            <span class="entity-type-name">{{ entity_info.name }}</span>
                            <br>
                            <small class="text-muted">
                                {{ t('tax_type_label', default='Tax Type') | e }}: {{ entity_info.tax_type }}
                                <br>
                                {{ entity_info.tax_details }}
                            </small>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                            data-bs-target="#entityTypeModal">
                            <i class="fas fa-edit"></i> {{ t('change_entity_type', default='Change') | e }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Input Form -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{{ t('income_expenses_title', default='Income & Expenses') | e }}</h3>
                </div>
                <div class="card-body">
                    <form id="taxCalculatorForm">
                        <!-- Annual Income Section -->
                        <div class="mb-4" role="group" aria-labelledby="income-heading">
                            <h4 class="mb-3" id="income-heading">{{ t('annual_income_title', default='Annual Income') |
                                e }}</h4>
                            <div class="form-group">
                                <label for="total_income" class="form-label">{{ t('income_label', default='Total Annual
                                    Income') | e }} (₦)</label>
                                <input type="number" class="form-control" id="total_income" name="total_income"
                                    placeholder="{{ t('total_income_placeholder', default='Enter your total annual income') | e }}"
                                    min="0" step="0.01"
                                    aria-label="{{ t('income_label', default='Total Annual Income') }}"
                                    aria-describedby="income-help" aria-required="true">
                                <div id="income-help" class="form-text">
                                    {{ t('income_help_text', default='Enter your total business income for the tax
                                    year') }}
                                </div>
                            </div>
                        </div>

                        <!-- Annual Rent Section -->
                        <div class="mb-4" role="group" aria-labelledby="rent-heading">
                            <h4 class="mb-3" id="rent-heading">{{ t('annual_rent_title', default='Annual Rent') | e }}
                            </h4>
                            <div class="form-group">
                                <label for="annual_rent" class="form-label">{{ t('rent_label', default='Annual Rent
                                    Paid') | e }} (₦)</label>
                                <input type="number" class="form-control" id="annual_rent" name="annual_rent"
                                    value="{{ user_annual_rent }}"
                                    placeholder="{{ t('annual_rent_placeholder', default='Enter your annual rent') | e }}"
                                    min="0" step="0.01" aria-label="{{ t('rent_label', default='Annual Rent Paid') }}"
                                    aria-describedby="rent-help">
                                <small class="form-text text-muted" id="rent-help">
                                    <i class="fas fa-info-circle text-info" aria-hidden="true"></i>
                                    {{ t('rent_relief_info', default='Rent relief is calculated as the lower of ₦500,000
                                    or 20% of your annual rent') | e }}
                                    <a href="{{ url_for('education.view_module', module_id='deductions_reliefs') }}#rent_relief"
                                        target="_blank" class="ml-2"
                                        aria-label="{{ t('learn_more', default='Learn more') }} {{ t('general_opens_new_window', default='(opens in new window)') }}">
                                        <i class="fas fa-graduation-cap" aria-hidden="true"></i> {{ t('learn_more',
                                        default='Learn more') }}
                                    </a>
                                </small>
                            </div>
                        </div>

                        <!-- Categorized Business Expenses Section -->
                        <div class="mb-4">
                            <h4 class="mb-3">{{ t('expense_categories_title', default='Business Expense Categories') | e
                                }}</h4>
                            <p class="text-muted mb-3">
                                {{ t('expense_categories_description', default='Enter your business expenses by
                                category. Categories are color-coded to show their tax treatment.') | e }}
                            </p>

                            <!-- Tax Deductible Categories (Step 1) -->
                            <div class="expense-group mb-4" role="group" aria-labelledby="step1-heading">
                                <h5 class="text-success mb-3" id="step1-heading">
                                    <i class="fas fa-check-circle" aria-hidden="true"></i> {{
                                    t('step1_deductible_title', default='Step 1: Main Business Expenses (Tax
                                    Deductible)') | e }}
                                </h5>
                                <p class="small text-muted mb-3" id="step1-description">{{ t('step1_description',
                                    default='These expenses are used to calculate your Net Business Profit in Step 1 of
                                    the tax calculation.') | e }}</p>

                                {% for category_key, category in expense_categories.items() %}
                                {% if category.tax_deductible and not category.is_statutory and not category.is_personal
                                %}
                                <div class="expense-category mb-3" role="group"
                                    aria-labelledby="{{ category_key }}-heading">
                                    <div class="card border-success">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="card-title mb-0" id="{{ category_key }}-heading">{{
                                                    category.name }}</h6>
                                                <span class="badge bg-success" role="status"
                                                    aria-label="{{ t('tax_deductible_indicator', default='Tax Deductible') }}">
                                                    <i class="fas fa-check-circle" aria-hidden="true"></i> {{
                                                    t('tax_deductible', default='Tax Deductible') | e }}
                                                </span>
                                            </div>
                                            <p class="card-text text-muted small" id="{{ category_key }}-description">{{
                                                category.description }}</p>
                                            <div class="form-group">
                                                <label for="{{ category_key }}" class="form-label">{{ t('amount_label',
                                                    default='Amount (₦)') | e }}</label>
                                                <input type="number" class="form-control expense-input"
                                                    id="{{ category_key }}" name="{{ category_key }}"
                                                    placeholder="{{ t('amount_placeholder', default='0.00') | e }}"
                                                    min="0" step="0.01" data-category-type="deductible"
                                                    aria-label="{{ category.name }} {{ t('amount_label', default='Amount') }}"
                                                    aria-describedby="{{ category_key }}-description {{ category_key }}-examples"
                                                    title="{{ category.description }}">
                                            </div>
                                            <div class="examples" id="{{ category_key }}-examples">
                                                <small class="text-muted">
                                                    <strong>{{ t('examples_label', default='Examples:') | e }}</strong>
                                                    {{ category.examples | join(', ') }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>

                            <!-- Statutory & Legal Contributions (Step 2) -->
                            <div class="expense-group mb-4" role="group" aria-labelledby="step2-heading">
                                <h5 class="text-info mb-3" id="step2-heading">
                                    <i class="fas fa-gavel" aria-hidden="true"></i> {{ t('step2_statutory_title',
                                    default='Step 2: Statutory & Legal Contributions') | e }}
                                </h5>
                                <p class="small text-muted mb-3" id="step2-description">{{ t('step2_description',
                                    default='These expenses are deducted separately in Step 2 of the tax calculation.')
                                    | e }}</p>

                                {% for category_key, category in expense_categories.items() %}
                                {% if category.is_statutory %}
                                <div class="expense-category mb-3">
                                    <div class="card border-info">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="card-title mb-0">{{ category.name }}</h6>
                                                <span class="badge bg-info">
                                                    <i class="fas fa-gavel"></i> {{ t('statutory_deduction',
                                                    default='Statutory Deduction') | e }}
                                                </span>
                                            </div>
                                            <p class="card-text text-muted small">{{ category.description }}</p>
                                            <div class="form-group">
                                                <label for="{{ category_key }}" class="form-label">{{ t('amount_label',
                                                    default='Amount (₦)') | e }}</label>
                                                <input type="number" class="form-control expense-input"
                                                    id="{{ category_key }}" name="{{ category_key }}"
                                                    placeholder="{{ t('amount_placeholder', default='0.00') | e }}"
                                                    min="0" step="0.01" data-category-type="statutory"
                                                    title="{{ category.description }}">
                                            </div>
                                            <div class="examples">
                                                <small class="text-muted">
                                                    <strong>{{ t('examples_label', default='Examples:') | e }}</strong>
                                                    {{ category.examples | join(', ') }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>

                            <!-- Personal Expenses (Non-deductible) -->
                            <div class="expense-group mb-4" role="group" aria-labelledby="personal-heading">
                                <h5 class="text-warning mb-3" id="personal-heading">
                                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i> {{
                                    t('personal_expenses_title', default='Personal Expenses (Not Tax Deductible)') | e
                                    }}
                                </h5>
                                <p class="small text-muted mb-3" id="personal-description">{{
                                    t('personal_expenses_description', default='These expenses are not included in tax
                                    calculations but can be tracked for record-keeping.') | e }}</p>

                                {% for category_key, category in expense_categories.items() %}
                                {% if category.is_personal %}
                                <div class="expense-category mb-3" role="group"
                                    aria-labelledby="{{ category_key }}-heading">
                                    <div class="card border-warning">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="card-title mb-0" id="{{ category_key }}-heading">{{
                                                    category.name }}</h6>
                                                <span class="badge bg-warning text-dark" role="status"
                                                    aria-label="{{ t('non_tax_deductible_indicator', default='Not Tax Deductible') }}">
                                                    <i class="fas fa-times-circle" aria-hidden="true"></i> {{
                                                    t('not_deductible', default='Not Deductible') | e }}
                                                </span>
                                            </div>
                                            <p class="card-text text-muted small" id="{{ category_key }}-description">{{
                                                category.description }}</p>
                                            <div class="alert alert-warning small" role="alert">
                                                <i class="fas fa-info-circle" aria-hidden="true"></i> {{
                                                t('personal_expense_warning', default='Personal expenses are not tax
                                                deductible') }}
                                            </div>
                                            <div class="form-group">
                                                <label for="{{ category_key }}" class="form-label">{{ t('amount_label',
                                                    default='Amount (₦)') | e }}</label>
                                                <input type="number" class="form-control expense-input"
                                                    id="{{ category_key }}" name="{{ category_key }}"
                                                    placeholder="{{ t('amount_placeholder', default='0.00') | e }}"
                                                    min="0" step="0.01" data-category-type="personal"
                                                    aria-label="{{ category.name }} {{ t('amount_label', default='Amount') }}"
                                                    aria-describedby="{{ category_key }}-description {{ category_key }}-examples {{ category_key }}-warning"
                                                    title="{{ category.description }}">
                                            </div>
                                            <div class="examples" id="{{ category_key }}-examples">
                                                <small class="text-muted">
                                                    <strong>{{ t('examples_label', default='Examples:') | e }}</strong>
                                                    {{ category.examples | join(', ') }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Help Section -->
                        <div class="help-section mb-4" role="region" aria-labelledby="help-heading">
                            <div class="card border-info">
                                <div class="card-header">
                                    <h6 class="mb-0" id="help-heading">
                                        <button class="btn btn-link text-decoration-none p-0" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#helpCollapse"
                                            aria-expanded="false" aria-controls="helpCollapse"
                                            aria-label="{{ t('how_it_works', default='How Tax Calculation Works') }} - {{ t('general_click_to_expand', default='Click to expand') }}">
                                            <i class="fas fa-question-circle text-info" aria-hidden="true"></i> {{
                                            t('how_it_works', default='How Tax Calculation Works') | e }}
                                            <i class="fas fa-chevron-down ms-2" aria-hidden="true"></i>
                                        </button>
                                    </h6>
                                </div>
                                <div class="collapse" id="helpCollapse">
                                    <div class="card-body">
                                        {% if user_entity_type == 'sole_proprietor' %}
                                        <p class="small mb-3">{{ t('pit_explanation', default='For sole proprietors, tax
                                            is calculated using a four-step process according to NTA 2025:') | e }}</p>
                                        <ol class="small">
                                            <li><strong>{{ t('step1_help', default='Net Business Profit:') | e
                                                    }}</strong> {{ t('step1_help_desc', default='Total income minus main
                                                business expenses (6 categories)') | e }}</li>
                                            <li><strong>{{ t('step2_help', default='Statutory Deductions:') | e
                                                    }}</strong> {{ t('step2_help_desc', default='Subtract statutory &
                                                legal contributions separately') | e }}</li>
                                            <li><strong>{{ t('step3_help', default='Rent Relief:') | e }}</strong> {{
                                                t('step3_help_desc', default='Apply rent relief (maximum ₦500,000 or 20%
                                                of rent)') | e }}</li>
                                            <li><strong>{{ t('step4_help', default='Progressive Tax:') | e }}</strong>
                                                {{ t('step4_help_desc', default='Apply progressive tax bands to final
                                                taxable income') | e }}</li>
                                        </ol>
                                        {% else %}
                                        <p class="small mb-3">{{ t('cit_explanation', default='For registered companies,
                                            tax is calculated using Companies Income Tax (CIT) rules:') | e }}</p>
                                        <ul class="small">
                                            <li><strong>{{ t('small_company_help', default='Small Companies (≤₦50M
                                                    revenue):') | e }}</strong> {{ t('small_company_help_desc',
                                                default='0% tax rate (exempt from CIT)') | e }}</li>
                                            <li><strong>{{ t('large_company_help', default='Large Companies (>₦50M
                                                    revenue):') | e }}</strong> {{ t('large_company_help_desc',
                                                default='30% tax rate on taxable income') | e }}</li>
                                        </ul>
                                        {% endif %}
                                        <p class="small text-muted mb-0">
                                            <i class="fas fa-info-circle"></i> {{ t('calculation_note',
                                            default='Personal expenses are not tax-deductible and are excluded from
                                            calculations.') | e }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Real-time Category Totals -->
                        <div class="category-totals mb-4" role="region" aria-labelledby="totals-heading"
                            aria-live="polite">
                            <h5 class="mb-3" id="totals-heading">{{ t('expense_totals_title', default='Expense Totals')
                                | e }}</h5>
                            <p class="small text-muted mb-3">
                                <i class="fas fa-info-circle"></i> {{ t('empty_fields_note', default='Empty fields are
                                treated as zero - you don\'t need to fill in every category') | e }}
                            </p>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card border-success" role="status" aria-labelledby="deductible-heading">
                                        <div class="card-body text-center py-3">
                                            <h6 class="card-title text-success mb-1" id="deductible-heading">{{
                                                t('deductible_expenses', default='Deductible Expenses') | e }}</h6>
                                            <h4 class="text-success mb-0" id="deductibleTotal" aria-live="polite"
                                                aria-label="{{ t('deductible_expenses', default='Deductible Expenses') }} total">
                                                ₦0.00</h4>
                                            <small class="text-muted">{{ t('step1_expenses', default='Step 1 Expenses')
                                                | e }}</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-info" role="status" aria-labelledby="statutory-heading">
                                        <div class="card-body text-center py-3">
                                            <h6 class="card-title text-info mb-1" id="statutory-heading">{{
                                                t('statutory_expenses', default='Statutory Expenses') | e }}</h6>
                                            <h4 class="text-info mb-0" id="statutoryTotal" aria-live="polite"
                                                aria-label="{{ t('statutory_expenses', default='Statutory Expenses') }} total">
                                                ₦0.00</h4>
                                            <small class="text-muted">{{ t('step2_expenses', default='Step 2 Expenses')
                                                | e }}</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-warning" role="status" aria-labelledby="personal-heading">
                                        <div class="card-body text-center py-3">
                                            <h6 class="card-title text-warning mb-1" id="personal-heading">{{
                                                t('personal_expenses', default='Personal Expenses') | e }}</h6>
                                            <h4 class="text-warning mb-0" id="personalTotal" aria-live="polite"
                                                aria-label="{{ t('personal_expenses', default='Personal Expenses') }} total">
                                                ₦0.00</h4>
                                            <small class="text-muted">{{ t('not_deductible', default='Not Deductible') |
                                                e }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-lg" aria-describedby="calculate-help"
                                aria-label="{{ t('calculate_button', default='Calculate Tax') }} - {{ t('general_submit_form', default='Submit form to calculate tax') }}">
                                <i class="fas fa-calculator" aria-hidden="true"></i> {{ t('calculate_button',
                                default='Calculate Tax') | e }}
                            </button>
                            <button type="button" class="btn btn-secondary" id="clearForm"
                                aria-label="{{ t('clear_form_button', default='Clear Form') }} - {{ t('general_clear_all_inputs', default='Clear all form inputs') }}">
                                <i class="fas fa-eraser" aria-hidden="true"></i> {{ t('clear_form_button',
                                default='Clear Form') | e }}
                            </button>
                            <div id="calculate-help" class="form-text mt-2">
                                {{ t('calculate_help_text', default='Click to calculate your tax liability based on the
                                entered income and expenses') }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tax Summary -->
        <div class="col-lg-4">
            <div class="card sticky-top">
                <div class="card-header">
                    <h3 class="card-title" id="tax-summary-heading">{{ t('tax_summary_title', default='Tax Summary') | e
                        }}</h3>
                </div>
                <div class="card-body" id="taxSummary" role="region" aria-labelledby="tax-summary-heading"
                    aria-live="polite">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-calculator fa-3x mb-3" aria-hidden="true"></i>
                        <p>{{ t('tax_summary_placeholder', default='Enter your income and expenses to see your tax
                            calculation') | e }}</p>
                    </div>
                </div>
            </div>

            <!-- Four-Step Process Information Card -->
            {% if user_entity_type == 'sole_proprietor' %}
            <div class="card mt-3" role="region" aria-labelledby="four-step-heading">
                <div class="card-header">
                    <h3 class="card-title" id="four-step-heading">
                        <i class="fas fa-list-ol" aria-hidden="true"></i> {{ t('four_step_process_title',
                        default='Four-Step Tax Calculation') | e }}
                    </h3>
                </div>
                <div class="card-body">
                    <div class="step-info mb-3" role="listitem">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-success me-2"
                                aria-label="{{ t('step_number', default='Step') }} 1">1</span>
                            <strong id="step1-info-title">{{ t('step1_title', default='Net Business Profit') | e
                                }}</strong>
                        </div>
                        <p class="small text-muted mb-0" aria-describedby="step1-info-title">{{ t('step1_info',
                            default='Income minus main business expenses (6 categories)') | e }}</p>
                    </div>

                    <div class="step-info mb-3" role="listitem">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-info me-2"
                                aria-label="{{ t('step_number', default='Step') }} 2">2</span>
                            <strong id="step2-info-title">{{ t('step2_title', default='Statutory Deductions') | e
                                }}</strong>
                        </div>
                        <p class="small text-muted mb-0" aria-describedby="step2-info-title">{{ t('step2_info',
                            default='Subtract statutory & legal contributions') | e }}</p>
                    </div>

                    <div class="step-info mb-3" role="listitem">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-warning me-2"
                                aria-label="{{ t('step_number', default='Step') }} 3">3</span>
                            <strong id="step3-info-title">{{ t('step3_title', default='Rent Relief') | e }}</strong>
                        </div>
                        <p class="small text-muted mb-0" aria-describedby="step3-info-title">{{ t('step3_info',
                            default='Apply rent relief (max ₦500,000 or 20% of rent)') | e }}</p>
                    </div>

                    <div class="step-info mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary me-2">4</span>
                            <strong>{{ t('step4_title', default='Progressive Tax') | e }}</strong>
                        </div>
                        <p class="small text-muted mb-0">{{ t('step4_info', default='Apply NTA 2025 progressive tax
                            bands') | e }}</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Tax Information Card -->
            <div class="card mt-3">
                <div class="card-header">
                    <h3 class="card-title">{{ t('tax_information_title', default='Tax Information') | e }}</h3>
                </div>
                <div class="card-body" id="taxInformationContent">
                    {% if user_entity_type == 'limited_liability' %}
                    <!-- CIT Information -->
                    <h5>{{ t('cit_rates_title', default='Companies Income Tax (CIT) Rates') | e }}</h5>
                    <div class="alert alert-success">
                        <h6 class="mb-2">{{ t('small_company_exemption', default='Small Company Exemption') | e }}</h6>
                        <p class="mb-1"><strong>₦0 - ₦50,000,000:</strong> 0% {{ t('tax_rate', default='tax rate') | e
                            }}</p>
                        <small class="text-muted">{{ t('small_company_note', default='Companies with annual revenue of
                            ₦50 million or less are exempt from CIT') | e }}</small>
                    </div>
                    <div class="alert alert-warning">
                        <h6 class="mb-2">{{ t('large_company_rate', default='Large Company Rate') | e }}</h6>
                        <p class="mb-1"><strong>Above ₦50,000,000:</strong> 30% {{ t('tax_rate', default='tax rate') | e
                            }}</p>
                        <small class="text-muted">{{ t('large_company_note', default='Companies with annual revenue
                            above ₦50 million pay 30% tax on taxable income') | e }}</small>
                    </div>

                    <hr>

                    <h6>{{ t('cit_deductions_title', default='CIT Deductions') | e }}</h6>
                    <p class="small text-muted">
                        {{ t('cit_deductions_description', default='For CIT purposes, all legitimate business expenses
                        are generally deductible from revenue to determine taxable income.') | e }}
                    </p>
                    {% else %}
                    <!-- PIT Information -->
                    <h5>{{ t('progressive_tax_rates_title', default='Progressive Tax Rates (NTA 2025)') | e }}</h5>
                    <ul class="list-unstyled">
                        <li><strong>₦0 - ₦800,000:</strong> 0%</li>
                        <li><strong>₦800,001 - ₦3,000,000:</strong> 15%</li>
                        <li><strong>₦3,000,001 - ₦12,000,000:</strong> 18%</li>
                        <li><strong>₦12,000,001 - ₦25,000,000:</strong> 21%</li>
                        <li><strong>₦25,000,001 - ₦50,000,000:</strong> 23%</li>
                        <li><strong>Above ₦50,000,000:</strong> 25%</li>
                    </ul>

                    <hr>

                    <h6>{{ t('rent_relief_title', default='Rent Relief') | e }}</h6>
                    <p class="small text-muted">
                        {{ t('rent_relief_description', default='You can claim rent relief equal to the lower of
                        ₦500,000 or 20% of your annual rent.') | e }}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Entity Type Selection Modal -->
<div class="modal fade" id="entityTypeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ t('select_entity_type', default='Select Business Entity Type') | e }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">{{ t('entity_type_description', default='Select your business entity type to
                    ensure accurate tax calculations according to Nigerian tax law.') | e }}</p>

                {% for entity_key, entity_data in available_entity_types.items() %}
                <div class="entity-option mb-3">
                    <div class="card {% if entity_key == user_entity_type %}border-primary{% endif %}">
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="entity_type" id="{{ entity_key }}"
                                    value="{{ entity_key }}" {% if entity_key==user_entity_type %}checked{% endif %}>
                                <label class="form-check-label w-100" for="{{ entity_key }}">
                                    <h6 class="mb-1">{{ entity_data.name }}</h6>
                                    <p class="text-muted mb-2">{{ entity_data.description }}</p>
                                    <small class="text-info">
                                        <strong>{{ entity_data.tax_type }}</strong><br>
                                        {{ entity_data.tax_details }}
                                    </small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('cancel', default='Cancel')
                    | e }}</button>
                <button type="button" class="btn btn-primary" id="saveEntityType">{{ t('save_changes', default='Save
                    Changes') | e }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">{{ t('loading_text', default='Loading...') | e }}</span>
                </div>
                <p class="mt-2">{{ t('calculating_tax_text', default='Calculating tax...') | e }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* Enhanced Tax Calculator Styles */
    .step-card {
        transition: all 0.3s ease;
    }

    .step-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .calculation-formula code {
        background-color: #f8f9fa;
        padding: 8px 12px;
        border-radius: 4px;
        display: block;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        border-left: 3px solid #007bff;
    }

    .tax-band-item {
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 12px;
        background-color: #f8f9fa;
        transition: background-color 0.2s ease;
    }

    .tax-band-item:hover {
        background-color: #e9ecef;
    }

    .progress-bar {
        background: linear-gradient(45deg, #007bff, #0056b3);
        transition: width 0.6s ease;
    }

    .expense-category .card {
        transition: all 0.2s ease;
    }

    .expense-category .card:hover {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .entity-type-info .alert {
        border-left: 4px solid #007bff;
    }

    .four-step-process .card-header {
        font-weight: 600;
    }

    .final-summary {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        border: 2px solid #007bff;
    }

    .progressive-tax-bands {
        background-color: #fff;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid #dee2e6;
    }

    .tax-bands-list {
        max-height: 300px;
        overflow-y: auto;
    }

    .summary-item {
        padding: 8px 0;
        border-bottom: 1px solid #f1f3f4;
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .step-card .card-body {
            padding: 12px;
        }

        .calculation-formula code {
            font-size: 0.8em;
            padding: 6px 8px;
        }

        .tax-band-item {
            padding: 8px;
        }
    }

    /* Visual indicators for category types */
    .border-success {
        border-color: #28a745 !important;
    }

    .border-info {
        border-color: #17a2b8 !important;
    }

    .border-warning {
        border-color: #ffc107 !important;
    }

    .bg-success {
        background-color: #28a745 !important;
    }

    .bg-info {
        background-color: #17a2b8 !important;
    }

    .bg-warning {
        background-color: #ffc107 !important;
    }

    .bg-primary {
        background-color: #007bff !important;
    }

    /* Accessibility improvements */
    .sr-only {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0, 0, 0, 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
    }

    /* High contrast focus indicators */
    .form-control:focus,
    .form-select:focus,
    .btn:focus {
        outline: 3px solid #0066cc;
        outline-offset: 2px;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.3);
    }

    /* Improved color contrast for badges */
    .badge.bg-success {
        background-color: #155724 !important;
        color: #ffffff !important;
    }

    .badge.bg-info {
        background-color: #0c5460 !important;
        color: #ffffff !important;
    }

    .badge.bg-warning {
        background-color: #856404 !important;
        color: #ffffff !important;
    }

    /* Enhanced visual indicators for tax deductible status */
    .card.border-success {
        border-left: 5px solid #28a745 !important;
    }

    .card.border-info {
        border-left: 5px solid #17a2b8 !important;
    }

    .card.border-warning {
        border-left: 5px solid #ffc107 !important;
    }

    /* Keyboard navigation indicators */
    .expense-input:focus {
        border-color: #0066cc;
        box-shadow: 0 0 0 0.2rem rgba(0, 102, 204, 0.25);
    }

    /* Screen reader announcements */
    [aria-live] {
        position: relative;
    }

    /* Improved button accessibility */
    .btn:focus-visible {
        outline: 3px solid #0066cc;
        outline-offset: 2px;
    }

    /* Enhanced tooltip accessibility */
    [data-bs-toggle="tooltip"]:focus {
        outline: 2px solid #0066cc;
        outline-offset: 1px;
    }

    /* Better contrast for help text */
    .form-text {
        color: #495057 !important;
        font-weight: 500;
    }

    /* Improved alert contrast */
    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }

    /* Focus management for collapsible sections */
    .collapse:focus {
        outline: 2px solid #0066cc;
        outline-offset: 2px;
    }
</style>
{% endblock %}

<!-- Tax Summary Modal -->
<div class="modal fade" id="taxSummaryModal" tabindex="-1" aria-labelledby="taxSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taxSummaryModalLabel">
                    <i class="fas fa-calculator"></i> {{ t('tax_calculation_summary', default='Tax Calculation Summary')
                    | e }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="{{ t('close', default='Close') | e }}"></button>
            </div>
            <div class="modal-body" id="taxSummaryModalBody">
                <!-- Tax summary content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> {{ t('close', default='Close') | e }}
                </button>
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> {{ t('print_summary', default='Print Summary') | e }}
                </button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<!-- Tax calculator functionality is now handled by external JavaScript file -->
<script>
    // Client-side error logging function
    function logClientError(error, details = {}) {
        try {
            fetch('/tax/log-client-error', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    error: error.toString(),
                    details: {
                        ...details,
                        userAgent: navigator.userAgent,
                        url: window.location.href,
                        timestamp: new Date().toISOString()
                    }
                })
            }).catch(logError => {
                console.error('Failed to log client error:', logError);
            });
        } catch (logError) {
            console.error('Error in logClientError:', logError);
        }
    }

    // Global error handler for unhandled errors
    window.addEventListener('error', function(event) {
        logClientError(event.error || event.message, {
            filename: event.filename,
            lineno: event.lineno,
            colno: event.colno
        });
    });

    // Validate template variables to catch JSON issues early
    try {
        // Test if template variables can be safely used
        const templateVars = {
            userEntityType: '{{ user_entity_type | e }}',
            userAnnualRent: {{ user_annual_rent | default(0) }},
            entityName: '{{ entity_info.name | e }}',
            entityTaxType: '{{ entity_info.tax_type | e }}'
        };
        
        // Log successful template variable parsing
        console.log('Template variables loaded successfully:', templateVars);
    } catch (templateError) {
        console.error('Template variable parsing error:', templateError);
        logClientError('Template variable parsing failed', {
            error: templateError.toString(),
            context: 'template_variables'
        });
    }

    // Legacy support for entity type changes and other functionality
    document.addEventListener('DOMContentLoaded', function () {

        // Most functionality moved to external tax-calculator-realtime.js file
        // This section only handles entity type changes
        input.addEventListener('keydown', function (e) {
            if (e.key === 'ArrowDown' && e.ctrlKey) {
                e.preventDefault();
                const nextInput = expenseInputs[index + 1];
                if (nextInput) {
                    nextInput.focus();
                }
            } else if (e.key === 'ArrowUp' && e.ctrlKey) {
                e.preventDefault();
                const prevInput = expenseInputs[index - 1];
                if (prevInput) {
                    prevInput.focus();
                }
            }
        });
    });

    // Announce dynamic content changes to screen readers
    const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
            if (mutation.type === 'childList' && mutation.target.id === 'taxSummary') {
                // Announce tax summary updates
                const summaryContent = mutation.target.textContent.trim();
                if (summaryContent && !summaryContent.includes('Enter your income')) {
                    announceToScreenReader('Tax calculation updated');
                }
            }
        });
    });

    observer.observe(summaryDiv, { childList: true, subtree: true });
        }

    // Function to announce messages to screen readers
    function announceToScreenReader(message) {
        const announcement = document.createElement('div');
        announcement.setAttribute('aria-live', 'polite');
        announcement.setAttribute('aria-atomic', 'true');
        announcement.className = 'sr-only';
        announcement.textContent = message;
        document.body.appendChild(announcement);

        setTimeout(() => {
            document.body.removeChild(announcement);
        }, 1000);
    }

    // Initialize accessibility features
    setupAccessibilityFeatures();

    // Real-time calculation variables
    let currentCalculation = null;
    let calculationTimeout = null;

    // Real-time expense totals update
    function updateExpenseTotals() {
        const deductibleInputs = document.querySelectorAll('.expense-input[data-category-type="deductible"]');
        const statutoryInputs = document.querySelectorAll('.expense-input[data-category-type="statutory"]');
        const personalInputs = document.querySelectorAll('.expense-input[data-category-type="personal"]');

        let deductibleTotal = 0;
        let statutoryTotal = 0;
        let personalTotal = 0;

        // Handle empty fields gracefully - parseFloat(empty) || 0 ensures empty fields = 0
        deductibleInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            deductibleTotal += value;
        });

        statutoryInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            statutoryTotal += value;
        });

        personalInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            personalTotal += value;
        });

        // Add visual feedback during update
        const deductibleElement = document.getElementById('deductibleTotal');
        const statutoryElement = document.getElementById('statutoryTotal');
        const personalElement = document.getElementById('personalTotal');

        // Add updating class for visual feedback
        [deductibleElement, statutoryElement, personalElement].forEach(el => {
            el.classList.add('updating');
        });

        // Update the totals display with animation
        setTimeout(() => {
            deductibleElement.textContent = formatCurrency(deductibleTotal);
            statutoryElement.textContent = formatCurrency(statutoryTotal);
            personalElement.textContent = formatCurrency(personalTotal);

            // Remove updating class
            [deductibleElement, statutoryElement, personalElement].forEach(el => {
                el.classList.remove('updating');
            });
        }, 150);
    }

    // Real-time tax summary update
    function updateRealTimeTaxSummary() {
        // Clear existing timeout
        if (calculationTimeout) {
            clearTimeout(calculationTimeout);
        }

        // Set new timeout for debounced calculation
        calculationTimeout = setTimeout(() => {
            performRealTimeCalculation();
        }, 500); // 500ms delay to avoid too frequent calculations
    }

    // Perform real-time tax calculation
    function performRealTimeCalculation() {
        const incomeValue = parseFloat(document.getElementById('total_income').value) || 0;
        const rentValue = parseFloat(document.getElementById('annual_rent').value) || 0;

        // Only calculate if there's income
        if (incomeValue <= 0) {
            showPlaceholderSummary();
            return;
        }

        // Collect expenses - include all categories, even if zero
        const expenses = {};
        const expenseInputs = document.querySelectorAll('.expense-input');
        expenseInputs.forEach(input => {
            const categoryKey = input.name;
            const amount = parseFloat(input.value) || 0;
            // Include all categories to ensure proper calculation
            expenses[categoryKey] = amount;
        });

        const data = {
            total_income: incomeValue,
            annual_rent: rentValue,
            expenses: expenses
        };

        // Perform calculation
        fetch('/tax/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    currentCalculation = result.breakdown;
                    updateTaxSummary(result.breakdown);
                } else {
                    showCalculationError();
                }
            })
            .catch(error => {
                console.error('Real-time calculation error:', error);
                showCalculationError();
            });
    }

    // Show placeholder when no income
    function showPlaceholderSummary() {
        summaryDiv.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-calculator fa-3x mb-3" aria-hidden="true"></i>
                    <p>{{ t('tax_summary_placeholder', default='Enter your income and expenses to see your tax calculation') | e }}</p>
                </div>
            `;
    }

    // Show calculation error
    function showCalculationError() {
        summaryDiv.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning" aria-hidden="true"></i>
                    <p>{{ t('calculation_error_placeholder', default='Unable to calculate tax. Please check your inputs.') | e }}</p>
                </div>
            `;
    }

    // Add event listeners for real-time updates
    function setupRealTimeUpdates() {
        // Income field
        const incomeField = document.getElementById('total_income');
        if (incomeField) {
            incomeField.addEventListener('input', () => {
                updateRealTimeTaxSummary();
            });
        }

        // Rent field
        const rentField = document.getElementById('annual_rent');
        if (rentField) {
            rentField.addEventListener('input', () => {
                updateRealTimeTaxSummary();
            });
        }

        // All expense inputs
        document.querySelectorAll('.expense-input').forEach(input => {
            input.addEventListener('input', () => {
                updateExpenseTotals();
                updateRealTimeTaxSummary();
            });
        });
    }

    // Initialize real-time updates
    setupRealTimeUpdates();
    updateExpenseTotals(); // Initial update

    // Clear form functionality
    const clearFormButton = document.getElementById('clearForm');
    if (clearFormButton) {
        clearFormButton.addEventListener('click', function () {
            if (confirm('{{ t("confirm_clear_form", default="Are you sure you want to clear all form data?") | e }}')) {
                // Clear all form inputs
                form.reset();

                // Clear validation states
                form.querySelectorAll('.is-invalid, .is-valid').forEach(field => {
                    field.classList.remove('is-invalid', 'is-valid');
                });

                // Remove validation error messages
                form.querySelectorAll('.validation-error').forEach(error => {
                    error.remove();
                });

                // Clear current calculation
                currentCalculation = null;

                // Reset totals and summary
                updateExpenseTotals();
                showPlaceholderSummary();

                // Focus on income field
                const incomeField = document.getElementById('total_income');
                if (incomeField) {
                    incomeField.focus();
                }
            }
        });
    }

    // Tax calculation validation functions
    function validateIncome(value) {
        const errors = [];
        if (!value || value.toString().trim() === '') {
            errors.push('{{ t("validation_income_required", default="Total income is required") }}');
        } else {
            const income = parseFloat(value);
            if (isNaN(income)) {
                errors.push('{{ t("validation_income_invalid", default="Please enter a valid income amount") }}');
            } else if (income < 0) {
                errors.push('{{ t("validation_income_negative", default="Income cannot be negative") }}');
            } else if (income > 9999999999.99) {
                errors.push('{{ t("validation_income_too_large", default="Income amount is unreasonably large") }}');
            }
        }
        return errors;
    }

    function validateRent(value) {
        const errors = [];
        if (value && value.toString().trim() !== '') {
            const rent = parseFloat(value);
            if (isNaN(rent)) {
                errors.push('{{ t("validation_rent_invalid", default="Please enter a valid rent amount") }}');
            } else if (rent < 0) {
                errors.push('{{ t("validation_rent_negative", default="Annual rent cannot be negative") }}');
            } else if (rent > 999999999.99) {
                errors.push('{{ t("validation_rent_too_large", default="Annual rent amount is unreasonably large") }}');
            }
        }
        return errors;
    }

    function validateExpenseAmount(value, categoryName) {
        const errors = [];
        // Only validate if there's actually a value (not empty/null/undefined)
        if (value && value.toString().trim() !== '') {
            const amount = parseFloat(value);
            if (isNaN(amount)) {
                errors.push(`{{ t("validation_expense_invalid", default="Please enter a valid amount for") }} ${categoryName}`);
            } else if (amount < 0) {
                errors.push(`{{ t("validation_expense_negative", default="Expense amount cannot be negative for") }} ${categoryName}`);
            } else if (amount > 999999999.99) {
                errors.push(`{{ t("validation_expense_too_large", default="Expense amount is unreasonably large for") }} ${categoryName}`);
            }
        }
        // Empty fields are valid (treated as zero)
        return errors;
    }

    function showFieldError(fieldId, errors) {
        const field = document.getElementById(fieldId);
        if (!field) return;

        const errorContainer = field.parentNode.querySelector('.validation-error');

        // Remove existing error container
        if (errorContainer) {
            errorContainer.remove();
        }

        // Add error styling
        if (errors.length > 0) {
            field.classList.add('is-invalid');

            // Create error container
            const errorDiv = document.createElement('div');
            errorDiv.className = 'validation-error text-danger mt-1 small';
            errorDiv.innerHTML = errors.map(error => `<div>${error}</div>`).join('');
            field.parentNode.appendChild(errorDiv);
        } else {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        }
    }

    function clearFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        if (!field) return;

        const errorContainer = field.parentNode.querySelector('.validation-error');

        if (errorContainer) {
            errorContainer.remove();
        }

        field.classList.remove('is-invalid', 'is-valid');
    }

    function validateForm() {
        let hasErrors = false;
        const errors = [];

        // Validate income
        const incomeField = document.getElementById('total_income');
        if (incomeField) {
            const incomeErrors = validateIncome(incomeField.value);
            showFieldError('total_income', incomeErrors);
            if (incomeErrors.length > 0) {
                hasErrors = true;
                errors.push(...incomeErrors);
            }
        }

        // Validate rent
        const rentField = document.getElementById('annual_rent');
        if (rentField) {
            const rentErrors = validateRent(rentField.value);
            showFieldError('annual_rent', rentErrors);
            if (rentErrors.length > 0) {
                hasErrors = true;
                errors.push(...rentErrors);
            }
        }

        // Validate expense amounts
        const expenseInputs = document.querySelectorAll('.expense-input');
        expenseInputs.forEach(input => {
            const categoryName = input.closest('.expense-category')?.querySelector('.card-title')?.textContent || input.id;
            const expenseErrors = validateExpenseAmount(input.value, categoryName);
            showFieldError(input.id, expenseErrors);
            if (expenseErrors.length > 0) {
                hasErrors = true;
                errors.push(...expenseErrors);
            }
        });

        return { isValid: !hasErrors, errors: errors };
    }

    // Add real-time validation
    const incomeField = document.getElementById('total_income');
    if (incomeField) {
        incomeField.addEventListener('blur', function () {
            const errors = validateIncome(this.value);
            showFieldError('total_income', errors);
        });

        incomeField.addEventListener('input', function () {
            if (this.classList.contains('is-invalid')) {
                const errors = validateIncome(this.value);
                if (errors.length === 0) {
                    clearFieldError('total_income');
                }
            }
        });
    }

    const rentField = document.getElementById('annual_rent');
    if (rentField) {
        rentField.addEventListener('blur', function () {
            const errors = validateRent(this.value);
            showFieldError('annual_rent', errors);
        });

        rentField.addEventListener('input', function () {
            if (this.classList.contains('is-invalid')) {
                const errors = validateRent(this.value);
                if (errors.length === 0) {
                    clearFieldError('annual_rent');
                }
            }
        });
    }

    // Add validation to expense inputs
    document.querySelectorAll('.expense-input').forEach(input => {
        input.addEventListener('blur', function () {
            const categoryName = this.closest('.expense-category')?.querySelector('.card-title')?.textContent || this.id;
            const errors = validateExpenseAmount(this.value, categoryName);
            showFieldError(this.id, errors);
        });

        input.addEventListener('input', function () {
            if (this.classList.contains('is-invalid')) {
                const categoryName = this.closest('.expense-category')?.querySelector('.card-title')?.textContent || this.id;
                const errors = validateExpenseAmount(this.value, categoryName);
                if (errors.length === 0) {
                    clearFieldError(this.id);
                }
            }
        });
    });

    // Format currency
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-NG', {
            style: 'currency',
            currency: 'NGN',
            minimumFractionDigits: 2
        }).format(amount);
    }

    // Format percentage
    function formatPercentage(rate) {
        return (rate).toFixed(2) + '%';
    }

    // Update tax summary based on entity type
    function updateTaxSummary(breakdown) {
        let html = '';

        if (breakdown.calculation_type === 'CIT') {
            // Companies Income Tax display
            html = generateCITSummary(breakdown);
        } else {
            // Personal Income Tax display with four-step breakdown
            html = generatePITSummary(breakdown);
        }

        summaryDiv.innerHTML = html;
    }

    // Generate CIT summary display
    function generateCITSummary(breakdown) {
        return `
                <div class="tax-breakdown">
                    <div class="alert alert-info mb-3">
                        <small><i class="fas fa-building"></i> <strong>Companies Income Tax (CIT)</strong></small>
                    </div>
                    
                    <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">{{ t('total_revenue_summary', default='Total Revenue:') | e }}</span>
                            <span class="text-success">${formatCurrency(breakdown.total_revenue || breakdown.total_income)}</span>
                        </div>
                    </div>
                    
                    ${breakdown.total_expenses ? `
                    <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span>{{ t('total_expenses_summary', default='Total Expenses:') | e }}</span>
                            <span class="text-danger">-${formatCurrency(breakdown.total_expenses)}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${breakdown.exemption_applied ? `
                    <div class="alert alert-success mb-3">
                        <small><i class="fas fa-check-circle"></i> <strong>Small Company Exemption Applied</strong><br>
                        Revenue ≤ ₦${formatCurrency(breakdown.revenue_threshold).replace('₦', '')} = 0% tax rate</small>
                    </div>
                    ` : `
                    <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">{{ t('taxable_income_label', default='Taxable Income:') | e }}</span>
                            <span class="fw-bold">${formatCurrency(breakdown.taxable_income)}</span>
                        </div>
                    </div>
                    
                    <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span>{{ t('cit_tax_rate', default='CIT Tax Rate:') | e }}</span>
                            <span>${formatPercentage(breakdown.tax_rate * 100)}</span>
                        </div>
                    </div>
                    `}
                    
                    <hr>
                    
                    <div class="summary-item mb-4">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold text-primary fs-5">{{ t('tax_liability_summary', default='Tax Liability:') | e }}</span>
                            <span class="fw-bold text-primary fs-5">${formatCurrency(breakdown.tax_liability)}</span>
                        </div>
                    </div>
                    
                    <div class="summary-item">
                        <div class="d-flex justify-content-between">
                            <span>{{ t('effective_tax_rate_summary', default='Effective Tax Rate:') | e }}</span>
                            <span>${formatPercentage(breakdown.effective_tax_rate)}</span>
                        </div>
                    </div>
                    
                    ${breakdown.calculation_steps ? generateCITStepsDisplay(breakdown.calculation_steps) : ''}
                </div>
            `;
    }

    // Generate PIT summary with four-step breakdown
    function generatePITSummary(breakdown) {
        const fourStepBreakdown = breakdown.four_step_breakdown || {};
        const summary = breakdown.summary || {};

        return `
                <div class="tax-breakdown">
                    <div class="alert alert-info mb-3">
                        <small><i class="fas fa-user"></i> <strong>Personal Income Tax (PIT) - Four-Step Calculation</strong></small>
                    </div>
                    
                    <!-- Four-Step Process Display -->
                    <div class="four-step-process mb-4">
                        ${generateStepDisplay(fourStepBreakdown.step1, 1, 'success')}
                        ${generateStepDisplay(fourStepBreakdown.step2, 2, 'info')}
                        ${generateStepDisplay(fourStepBreakdown.step3, 3, 'warning')}
                        ${generateStepDisplay(fourStepBreakdown.step4, 4, 'primary')}
                    </div>
                    
                    <!-- Final Summary -->
                    <div class="final-summary">
                        <hr>
                        <div class="summary-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold">{{ t('final_taxable_income', default='Final Taxable Income:') | e }}</span>
                                <span class="fw-bold">${formatCurrency(summary.final_taxable_income || 0)}</span>
                            </div>
                        </div>
                        
                        <div class="summary-item mb-4">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold text-primary fs-5">{{ t('tax_liability_summary', default='Tax Liability:') | e }}</span>
                                <span class="fw-bold text-primary fs-5">${formatCurrency(summary.tax_liability || 0)}</span>
                            </div>
                        </div>
                        
                        <div class="summary-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span>{{ t('effective_tax_rate_summary', default='Effective Tax Rate:') | e }}</span>
                                <span>${formatPercentage(summary.effective_tax_rate || 0)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progressive Tax Bands Visualization -->
                    ${fourStepBreakdown.step4 && fourStepBreakdown.step4.tax_band_breakdown ?
                generateProgressiveTaxBandsDisplay(fourStepBreakdown.step4.tax_band_breakdown) : ''}
                </div>
            `;
    }

    // Generate individual step display for PIT
    function generateStepDisplay(stepData, stepNumber, colorClass) {
        if (!stepData) return '';

        return `
                <div class="step-card mb-3">
                    <div class="card border-${colorClass}">
                        <div class="card-header bg-${colorClass} text-white py-2">
                            <h6 class="mb-0">
                                <i class="fas fa-calculator"></i> 
                                Step ${stepNumber}: ${stepData.step_name || 'Calculation Step'}
                            </h6>
                        </div>
                        <div class="card-body py-2">
                            <p class="small text-muted mb-2">${stepData.description || ''}</p>
                            <div class="calculation-formula">
                                <code class="small">${stepData.formula || ''}</code>
                            </div>
                            ${stepData.calculation_note ? `
                                <small class="text-info d-block mt-2">
                                    <i class="fas fa-info-circle"></i> ${stepData.calculation_note}
                                </small>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
    }

    // Generate CIT calculation steps display
    function generateCITStepsDisplay(steps) {
        if (!steps || !Array.isArray(steps)) return '';

        return `
                <div class="calculation-steps mt-4">
                    <h6 class="mb-3">{{ t('calculation_steps', default='Calculation Steps:') | e }}</h6>
                    ${steps.map(step => `
                        <div class="step-item mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small"><strong>Step ${step.step}:</strong> ${step.description}</span>
                                <span class="badge bg-secondary">${typeof step.result === 'number' ? formatCurrency(step.result) : step.result}</span>
                            </div>
                            <div class="small text-muted">${step.calculation}</div>
                        </div>
                    `).join('')}
                </div>
            `;
    }

    // Generate progressive tax bands visualization
    function generateProgressiveTaxBandsDisplay(taxBands) {
        if (!taxBands || !Array.isArray(taxBands) || taxBands.length === 0) return '';

        const totalTax = taxBands.reduce((sum, band) => sum + (band.tax_amount || 0), 0);

        return `
                <div class="progressive-tax-bands mt-4">
                    <hr>
                    <h6 class="mb-3">
                        <i class="fas fa-chart-bar"></i> {{ t('progressive_tax_breakdown', default='Progressive Tax Breakdown:') | e }}
                    </h6>
                    <div class="tax-bands-list">
                        ${taxBands.map((band, index) => {
            const percentage = totalTax > 0 ? (band.tax_amount / totalTax * 100) : 0;
            return `
                                <div class="tax-band-item mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small fw-bold">${band.description}</span>
                                        <span class="badge bg-primary">${formatCurrency(band.tax_amount)}</span>
                                    </div>
                                    <div class="progress mb-1" style="height: 8px;">
                                        <div class="progress-bar bg-gradient" role="progressbar" 
                                             style="width: ${percentage}%" 
                                             aria-valuenow="${percentage}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                    <div class="small text-muted">${band.formula}</div>
                                </div>
                            `;
        }).join('')}
                    </div>
                    <div class="total-tax-summary mt-3 pt-2 border-top">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">{{ t('total_progressive_tax', default='Total Progressive Tax:') | e }}</span>
                            <span class="fw-bold text-primary">${formatCurrency(totalTax)}</span>
                        </div>
                    </div>
                </div>
            `;
    }

    // Handle form submission - Show tax summary modal
    form.addEventListener('submit', function (e) {
        e.preventDefault();

        // Validate form before submission
        const validation = validateForm();
        if (!validation.isValid) {
            // Show validation errors
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                    <strong>{{ t("validation_form_errors", default="Please correct the following errors:") }}</strong>
                    <ul class="mb-0 mt-2">
                        ${validation.errors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

            // Remove existing alert
            const existingAlert = form.querySelector('.alert-danger');
            if (existingAlert) {
                existingAlert.remove();
            }

            form.insertBefore(alertDiv, form.firstChild);

            // Scroll to first error
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }

            return;
        }

        // Use current calculation if available, otherwise perform new calculation
        if (currentCalculation) {
            showTaxSummaryModal(currentCalculation);
        } else {
            // Show loading modal
            loadingModal.show();

            // Collect form data
            const formData = new FormData(form);

            // Collect categorized expenses - include all categories, even if zero
            const expenses = {};
            const expenseInputs = form.querySelectorAll('.expense-input');
            expenseInputs.forEach(input => {
                const categoryKey = input.name;
                const amount = parseFloat(input.value) || 0;
                // Include all categories to ensure proper calculation
                expenses[categoryKey] = amount;
            });

            const data = {
                total_income: parseFloat(formData.get('total_income')) || 0,
                annual_rent: parseFloat(formData.get('annual_rent')) || 0,
                expenses: expenses
            };

            // Send calculation request
            fetch('/tax/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    loadingModal.hide();

                    if (result.success) {
                        currentCalculation = result.breakdown;
                        updateTaxSummary(result.breakdown);
                        showTaxSummaryModal(result.breakdown);

                        // Update annual rent in database if changed
                        const currentRent = {{ user_annual_rent }
                    };
                    if (parseFloat(data.annual_rent) !== currentRent) {
                        updateAnnualRent(data.annual_rent);
                    }
                } else {
                    showAlert('danger', '{{ t("tax_calculation_error", default="Error calculating tax:") | e }} ' + (result.message || result.error));
        }
    })
        .catch(error => {
            loadingModal.hide();
            console.error('Error:', error);
            showAlert('danger', '{{ t("tax_calculation_network_error", default="An error occurred while calculating tax. Please check your connection and try again.") | e }}');
        });
            }
        });

    // Show tax summary modal
    function showTaxSummaryModal(breakdown) {
        const modalBody = document.getElementById('taxSummaryModalBody');
        if (!modalBody) return;

        // Generate detailed modal content
        let modalContent = '';

        if (breakdown.calculation_type === 'CIT') {
            modalContent = generateCITModalContent(breakdown);
        } else {
            modalContent = generatePITModalContent(breakdown);
        }

        modalBody.innerHTML = modalContent;

        // Show the modal
        const taxSummaryModal = new bootstrap.Modal(document.getElementById('taxSummaryModal'));
        taxSummaryModal.show();
    }

    // Generate CIT modal content
    function generateCITModalContent(breakdown) {
        return `
                <div class="tax-modal-content">
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-building fa-2x me-3"></i>
                            <div>
                                <h5 class="mb-1">Companies Income Tax (CIT) Summary</h5>
                                <small>{{ t('cit_modal_subtitle', default='Tax calculation for registered limited liability company') | e }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h6 class="text-success">{{ t('total_revenue', default='Total Revenue') | e }}</h6>
                                    <h3 class="text-success mb-0">${formatCurrency(breakdown.total_revenue || breakdown.total_income)}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h6 class="text-primary">{{ t('tax_liability', default='Tax Liability') | e }}</h6>
                                    <h3 class="text-primary mb-0">${formatCurrency(breakdown.tax_liability)}</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${breakdown.exemption_applied ? `
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle"></i> Small Company Exemption Applied</h6>
                            <p class="mb-0">Your company qualifies for the small company exemption (revenue ≤ ₦${formatCurrency(breakdown.revenue_threshold).replace('₦', '')}) and is exempt from CIT.</p>
                        </div>
                    ` : `
                        <div class="calculation-details mb-4">
                            <h6>{{ t('calculation_breakdown', default='Calculation Breakdown') | e }}</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>{{ t('total_revenue', default='Total Revenue') | e }}</td>
                                    <td class="text-end">${formatCurrency(breakdown.total_revenue || breakdown.total_income)}</td>
                                </tr>
                                <tr>
                                    <td>{{ t('total_expenses', default='Total Expenses') | e }}</td>
                                    <td class="text-end text-danger">-${formatCurrency(breakdown.total_expenses || 0)}</td>
                                </tr>
                                <tr class="table-active">
                                    <td><strong>{{ t('taxable_income', default='Taxable Income') | e }}</strong></td>
                                    <td class="text-end"><strong>${formatCurrency(breakdown.taxable_income)}</strong></td>
                                </tr>
                                <tr>
                                    <td>{{ t('tax_rate', default='Tax Rate') | e }}</td>
                                    <td class="text-end">${formatPercentage(breakdown.tax_rate * 100)}</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>{{ t('tax_liability', default='Tax Liability') | e }}</strong></td>
                                    <td class="text-end"><strong>${formatCurrency(breakdown.tax_liability)}</strong></td>
                                </tr>
                            </table>
                        </div>
                    `}

                    <div class="text-center">
                        <p class="text-muted small">{{ t('effective_tax_rate', default='Effective Tax Rate') | e }}: ${formatPercentage(breakdown.effective_tax_rate)}</p>
                    </div>
                </div>
            `;
    }

    // Generate PIT modal content
    function generatePITModalContent(breakdown) {
        const fourStepBreakdown = breakdown.four_step_breakdown || {};
        const summary = breakdown.summary || {};

        return `
                <div class="tax-modal-content">
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user fa-2x me-3"></i>
                            <div>
                                <h5 class="mb-1">Personal Income Tax (PIT) Summary</h5>
                                <small>{{ t('pit_modal_subtitle', default='Four-step tax calculation for sole proprietors') | e }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h6 class="text-success">{{ t('total_income', default='Total Income') | e }}</h6>
                                    <h3 class="text-success mb-0">${formatCurrency(summary.total_income || 0)}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h6 class="text-primary">{{ t('tax_liability', default='Tax Liability') | e }}</h6>
                                    <h3 class="text-primary mb-0">${formatCurrency(summary.tax_liability || 0)}</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="four-step-modal-breakdown mb-4">
                        <h6 class="mb-3">{{ t('four_step_calculation', default='Four-Step Calculation Process') | e }}</h6>
                        
                        ${generateModalStepCard(fourStepBreakdown.step1, 1, 'success', 'Net Business Profit')}
                        ${generateModalStepCard(fourStepBreakdown.step2, 2, 'info', 'Statutory Deductions')}
                        ${generateModalStepCard(fourStepBreakdown.step3, 3, 'warning', 'Rent Relief')}
                        ${generateModalStepCard(fourStepBreakdown.step4, 4, 'primary', 'Progressive Tax')}
                    </div>

                    <div class="final-summary-table">
                        <h6>{{ t('final_summary', default='Final Summary') | e }}</h6>
                        <table class="table table-sm">
                            <tr>
                                <td>{{ t('total_income', default='Total Income') | e }}</td>
                                <td class="text-end">${formatCurrency(summary.total_income || 0)}</td>
                            </tr>
                            <tr>
                                <td>{{ t('total_deductions', default='Total Deductions') | e }}</td>
                                <td class="text-end text-danger">-${formatCurrency((summary.total_deductible_expenses || 0) + (summary.statutory_expenses || 0) + (summary.rent_relief || 0))}</td>
                            </tr>
                            <tr class="table-active">
                                <td><strong>{{ t('final_taxable_income', default='Final Taxable Income') | e }}</strong></td>
                                <td class="text-end"><strong>${formatCurrency(summary.final_taxable_income || 0)}</strong></td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>{{ t('tax_liability', default='Tax Liability') | e }}</strong></td>
                                <td class="text-end"><strong>${formatCurrency(summary.tax_liability || 0)}</strong></td>
                            </tr>
                        </table>
                        <div class="text-center mt-3">
                            <p class="text-muted small">{{ t('effective_tax_rate', default='Effective Tax Rate') | e }}: ${formatPercentage(summary.effective_tax_rate || 0)}</p>
                        </div>
                    </div>
                </div>
            `;
    }

    // Generate modal step card
    function generateModalStepCard(stepData, stepNumber, colorClass, stepTitle) {
        if (!stepData) return '';

        return `
                <div class="modal-step-card mb-3">
                    <div class="card border-${colorClass}">
                        <div class="card-header bg-${colorClass} text-white py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-calculator"></i> Step ${stepNumber}: ${stepTitle}</span>
                                <span class="badge bg-light text-dark">${formatCurrency(getStepResult(stepData))}</span>
                            </div>
                        </div>
                        <div class="card-body py-2">
                            <div class="small">
                                <code>${stepData.formula || ''}</code>
                            </div>
                            ${stepData.calculation_note ? `
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-info-circle"></i> ${stepData.calculation_note}
                                </small>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
    }

    // Get step result value
    function getStepResult(stepData) {
        if (!stepData) return 0;

        if (stepData.net_business_profit !== undefined) return stepData.net_business_profit;
        if (stepData.adjusted_profit_after_statutory !== undefined) return stepData.adjusted_profit_after_statutory;
        if (stepData.taxable_income_after_rent_relief !== undefined) return stepData.taxable_income_after_rent_relief;
        if (stepData.tax_liability !== undefined) return stepData.tax_liability;

        return 0;
    }

    // Show alert function
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

        // Remove existing alerts
        const existingAlerts = form.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());

        form.insertBefore(alertDiv, form.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Update annual rent in database
    function updateAnnualRent(annualRent) {
        fetch('/tax/update-rent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ annual_rent: annualRent })
        })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    console.error('Failed to update annual rent:', result.error);
                }
            })
            .catch(error => {
                console.error('Error updating annual rent:', error);
            });
    }

    // Handle entity type change
    document.getElementById('saveEntityType').addEventListener('click', function () {
        const selectedEntityType = document.querySelector('input[name="entity_type"]:checked');
        if (!selectedEntityType) {
            alert('Please select an entity type');
            return;
        }

        const entityType = selectedEntityType.value;

        // Show loading
        const saveButton = this;
        const originalText = saveButton.textContent;
        saveButton.disabled = true;
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

        // Update entity type
        fetch('/tax/update-entity-type', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ entity_type: entityType })
        })
            .then(response => response.json())
            .then(result => {
                saveButton.disabled = false;
                saveButton.textContent = originalText;

                if (result.success) {
                    // Update UI with new entity type
                    document.querySelector('.entity-type-name').textContent = result.entity_info.name;

                    // Update tax information section
                    updateTaxInformationSection(result.entity_info, entityType);

                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('entityTypeModal')).hide();

                    // Clear current calculation
                    clearTaxSummary();

                    // Show success message
                    showAlert('success', 'Entity type updated successfully. Please recalculate your tax.');
                } else {
                    showAlert('danger', 'Error updating entity type: ' + result.error);
                }
            })
            .catch(error => {
                saveButton.disabled = false;
                saveButton.textContent = originalText;
                console.error('Error:', error);
                showAlert('danger', 'An error occurred while updating entity type');
            });
    });

    // Update tax information section based on entity type
    function updateTaxInformationSection(entityInfo, entityType) {
        const taxInfoContent = document.getElementById('taxInformationContent');

        if (entityType === 'limited_liability') {
            // CIT Information
            taxInfoContent.innerHTML = `
                <h5>{{ t('cit_rates_title', default='Companies Income Tax (CIT) Rates') | e }}</h5>
                <div class="alert alert-success">
                    <h6 class="mb-2">{{ t('small_company_exemption', default='Small Company Exemption') | e }}</h6>
                    <p class="mb-1"><strong>₦0 - ₦50,000,000:</strong> 0% {{ t('tax_rate', default='tax rate') | e }}</p>
                    <small class="text-muted">{{ t('small_company_note', default='Companies with annual revenue of ₦50 million or less are exempt from CIT') | e }}</small>
                </div>
                <div class="alert alert-warning">
                    <h6 class="mb-2">{{ t('large_company_rate', default='Large Company Rate') | e }}</h6>
                    <p class="mb-1"><strong>Above ₦50,000,000:</strong> 30% {{ t('tax_rate', default='tax rate') | e }}</p>
                    <small class="text-muted">{{ t('large_company_note', default='Companies with annual revenue above ₦50 million pay 30% tax on taxable income') | e }}</small>
                </div>
                
                <hr>
                
                <h6>{{ t('cit_deductions_title', default='CIT Deductions') | e }}</h6>
                <p class="small text-muted">
                    {{ t('cit_deductions_description', default='For CIT purposes, all legitimate business expenses are generally deductible from revenue to determine taxable income.') | e }}
                </p>
            `;
        } else {
            // PIT Information
            taxInfoContent.innerHTML = `
                <h5>{{ t('progressive_tax_rates_title', default='Progressive Tax Rates (NTA 2025)') | e }}</h5>
                <ul class="list-unstyled">
                    <li><strong>₦0 - ₦800,000:</strong> 0%</li>
                    <li><strong>₦800,001 - ₦3,000,000:</strong> 15%</li>
                    <li><strong>₦3,000,001 - ₦12,000,000:</strong> 18%</li>
                    <li><strong>₦12,000,001 - ₦25,000,000:</strong> 21%</li>
                    <li><strong>₦25,000,001 - ₦50,000,000:</strong> 23%</li>
                    <li><strong>Above ₦50,000,000:</strong> 25%</li>
                </ul>

                <hr>

                <h6>{{ t('rent_relief_title', default='Rent Relief') | e }}</h6>
                <p class="small text-muted">
                    {{ t('rent_relief_description', default='You can claim rent relief equal to the lower of
                    ₦500,000 or 20% of your annual rent.') | e }}
                </p>
            `;
        }
    }

    // Show alert message
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // Insert at top of page
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Clear tax summary
    function clearTaxSummary() {
        summaryDiv.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-calculator fa-3x mb-3"></i>
                <p>{{ t('tax_summary_placeholder', default='Enter your income and expenses to see your tax calculation') | e }}</p>
            </div>
        `;
    }

    // Clear form
    document.getElementById('clearForm').addEventListener('click', function () {
        form.reset();
        clearTaxSummary();
    });

    // Update category totals in real-time
    function updateCategoryTotals() {
        let deductibleTotal = 0;
        let statutoryTotal = 0;
        let personalTotal = 0;

        const expenseInputs = form.querySelectorAll('.expense-input');
        expenseInputs.forEach(input => {
            const amount = parseFloat(input.value) || 0;
            const categoryType = input.getAttribute('data-category-type');

            switch (categoryType) {
                case 'deductible':
                    deductibleTotal += amount;
                    break;
                case 'statutory':
                    statutoryTotal += amount;
                    break;
                case 'personal':
                    personalTotal += amount;
                    break;
            }
        });

        // Update display
        document.getElementById('deductibleTotal').textContent = formatCurrency(deductibleTotal);
        document.getElementById('statutoryTotal').textContent = formatCurrency(statutoryTotal);
        document.getElementById('personalTotal').textContent = formatCurrency(personalTotal);
    }

    // Auto-calculate on input change (debounced)
    let calculateTimeout;
    const inputs = form.querySelectorAll('input[type="number"]');
    inputs.forEach(input => {
        input.addEventListener('input', function () {
            // Update category totals immediately
            updateCategoryTotals();

            clearTimeout(calculateTimeout);
            calculateTimeout = setTimeout(() => {
                // Only auto-calculate if total income is entered
                const totalIncome = document.getElementById('total_income').value;
                if (totalIncome && parseFloat(totalIncome) > 0) {
                    form.dispatchEvent(new Event('submit'));
                }
            }, 1000);
        });
    });

    // Entity type change handler
    const saveEntityButton = document.getElementById('saveEntityType');
    if (saveEntityButton) {
        saveEntityButton.addEventListener('click', function () {
            const selectedEntityType = document.querySelector('input[name="entity_type"]:checked');
            if (!selectedEntityType) {
                alert('Please select an entity type');
                return;
            }

            const entityType = selectedEntityType.value;

            // Show loading
            const saveButton = this;
            const originalText = saveButton.textContent;
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

            // Update entity type
            fetch('/tax/update-entity-type', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ entity_type: entityType })
            })
                .then(response => response.json())
                .then(result => {
                    saveButton.disabled = false;
                    saveButton.textContent = originalText;

                    if (result.success) {
                        // Update UI with new entity type
                        document.querySelector('.entity-type-name').textContent = result.entity_info.name;

                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById('entityTypeModal')).hide();

                        // Show success message and clear calculation
                        if (window.taxCalculator) {
                            window.taxCalculator.showAlert('success', 'Entity type updated successfully. Please recalculate your tax.');
                            window.taxCalculator.currentCalculation = null;
                            window.taxCalculator.showInitialSummary();
                        }
                    } else {
                        if (window.taxCalculator) {
                            window.taxCalculator.showAlert('danger', 'Error updating entity type: ' + result.error);
                        }
                    }
                })
                .catch(error => {
                    saveButton.disabled = false;
                    saveButton.textContent = originalText;
                    console.error('Error:', error);
                    if (window.taxCalculator) {
                        window.taxCalculator.showAlert('danger', 'An error occurred while updating entity type');
                    }
                });
        });
    }
});
</script>

{% endblock %}