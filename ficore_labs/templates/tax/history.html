<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script>{% extends "base.html" %}
{% block title %}{{ t('tax_history', default='Tax History') }}{% endblock %}
{% block content %}
<!-- Add CSRF meta tag for potential AJAX submissions -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container mt-4">
    {% set tool_name = 'tax_history' %}
    {% set tool_icon = 'fa-history' %}
    {% set subtitle = t('tax_history_description', default='Review and manage your past tax calculations') %}
    {% include 'tool_header.html' %}

    <!-- Navigation Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('tax.index') }}">{{ t('tax_calculator_title', default='Tax Calculator') }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ t('tax_history', default='Tax History') }}</li>
        </ol>
    </nav>

    {% if calculations %}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0">{{ t('tax_your_calculations', default='Your Tax Calculations') }} ({{ calculations|length }})</h5>
            <a href="{{ url_for('tax.new') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>{{ t('tax_calculate_new', default='Calculate Tax') }}
            </a>
        </div>

        <div class="row">
            {% for calc_id, calc in calculations.items() %}
                <div class="col-lg-6 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">{{ t('tax_calculation', default='Tax Calculation') }} - {{ calc.created_at }}</h6>
                                <small class="text-muted">{{ calc.user_email }}</small>
                            </div>
                            <span class="badge bg-danger">{{ t('tax_total_tax', default='Total Tax') }}: {{ calc.total_tax }}</span>
                        </div>
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-4">
                                    <small class="text-muted d-block">{{ t('tax_income', default='Income') }}</small>
                                    <strong class="text-primary">{{ calc.income }}</strong>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">{{ t('tax_taxable_income', default='Taxable Income') }}</small>
                                    <strong class="text-info">{{ calc.taxable_income }}</strong>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">{{ t('tax_total_tax', default='Total Tax') }}</small>
                                    <strong class="text-danger">{{ calc.total_tax }}</strong>
                                </div>
                            </div>

                            {% if calc.deductions %}
                                <div class="mt-3">
                                    <small class="text-muted d-block mb-1"><i class="fas fa-receipt text-warning me-1"></i>{{ t('tax_deductions', default='Deductions') }}</small>
                                    <ul class="list-unstyled small">
                                        {% for item in calc.deductions[:3] %}
                                            <li class="mb-1">{{ item.name }}: {{ item.amount | format_currency }} {% if item.note %}({{ item.note | e }}){% endif %}</li>
                                        {% endfor %}
                                        {% if calc.deductions|length > 3 %}
                                            <li class="text-muted">{{ t('tax_and_more', default='and {count} more...')|replace('{count}', (calc.deductions|length - 3)|string) }}</li>
                                        {% endif %}
                                    </ul>
                                </div>
                            {% else %}
                                <div class="mt-3">
                                    <small class="text-muted">{{ t('tax_no_deductions', default='No deductions recorded') }}</small>
                                </div>
                            {% endif %}

                            <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                <div>
                                    <small class="text-muted">{{ t('tax_created', default='Created') }}: {{ calc.created_at }}</small>
                                </div>
                                <div>
                                    <form method="POST" action="{{ url_for('tax.history') }}" style="display: inline;" class="delete-form">
                                        {{ csrf_token() }}
                                        <input type="hidden" name="tax_id" value="{{ calc_id }}">
                                        <input type="hidden" name="action" value="delete">
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('{{ t('tax_confirm_delete', default='Are you sure you want to delete this tax calculation?') | e }}');">
                                            <i class="fas fa-trash me-1"></i>{{ t('general_delete', default='Delete') }}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        {% if calculations|length >= 20 %}
            <div class="text-center mt-4">
                <p class="text-muted">{{ t('tax_showing_recent', default='Showing most recent tax calculations') }}</p>
            </div>
        {% endif %}
    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-history fa-4x mb-3 text-muted"></i>
            <h4 class="text-muted">{{ t('tax_no_calculations_empty_state', default='No tax calculations yet') }}</h4>
            <p class="text-muted">{{ t('tax_get_started_description', default='Calculate your first tax to see your tax liability') }}</p>
            <a href="{{ url_for('tax.new') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus me-2"></i>{{ t('tax_calculate_new', default='Calculate Tax') }}
            </a>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper function to show alerts
    function showAlert(type, message) {
        const alertContainer = document.createElement('div');
        alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
        alertContainer.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.container').prepend(alertContainer);
        setTimeout(() => alertContainer.remove(), 5000);
    }

    // Attach event listeners to delete forms for AJAX submission
    document.querySelectorAll('.delete-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!confirm('{{ t('tax_confirm_delete', default='Are you sure you want to delete this tax calculation?') | e }}')) {
                return;
            }

            const formData = new FormData(form);
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

            fetch('{{ url_for("tax.history") }}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json().then(data => ({ status: response.status, data })))
            .then(({ status, data }) => {
                if (status === 200 && data.success) {
                    showAlert('success', '{{ t("tax_deleted_success", default="Tax calculation deleted successfully!") | e }}');
                    form.closest('.col-lg-6').remove();
                    const calcCount = document.querySelectorAll('.col-lg-6').length;
                    document.querySelector('h5.mb-0').textContent = `{{ t('tax_your_calculations', default='Your Tax Calculations') }} (${calcCount})`;
                    if (calcCount === 0) {
                        location.reload();
                    }
                } else {
                    showAlert('danger', data.message || '{{ t("tax_delete_failed", default="Error deleting tax calculation.") | e }}');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', '{{ t("tax_delete_failed", default="Error deleting tax calculation.") | e }}');
            });
        });
    });
});
</script>
{% endblock %}