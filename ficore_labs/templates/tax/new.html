{% extends "base.html" %}
{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
{% block title %}{{ t('tax_calculate_new', default='Calculate Tax') }}{% endblock %}
{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container mt-4">
    {% set tool_name = 'tax_calculate_new' %}
    {% set tool_icon = 'fa-calculator' %}
    {% set subtitle = t('tax_calculate_description', default='Enter your annual income, rent expenses, pension contributions, and deductions to calculate your tax liability') %}
    {% include 'tool_header.html' %}

    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('tax.index') }}">{{ t('tax_calculator_title', default='Tax Calculator') }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ t('tax_calculate_new', default='Calculate Tax') }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form id="tax-form" method="POST" action="{{ url_for('tax.new') }}">
                        {{ form.csrf_token }}

                        <!-- Annual Income -->
                        <div class="mb-3">
                            <label for="income" class="form-label">{{ form.income.label }}</label>
                            <input type="number" class="form-control income-input" id="income" name="income" min="0" max="10000000000" step="0.01" placeholder="500000.00" value="{{ form.income.data or '' }}">
                            {% if form.income.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.income.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ t('tax_income_help', default='Enter your total annual income before deductions (NGN)') }}</small>
                        </div>

                        <!-- Annual Rent Expenses -->
                        <div class="mb-3">
                            <label for="rent_expenses" class="form-label">{{ form.rent_expenses.label }}</label>
                            <input type="number" class="form-control income-input" id="rent_expenses" name="rent_expenses" min="0" max="10000000000" step="0.01" placeholder="250000.00" value="{{ form.rent_expenses.data or '' }}">
                            {% if form.rent_expenses.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.rent_expenses.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ t('tax_rent_relief_help', default='Enter your annual rent expenses. Relief is calculated as the lower of ₦500,000 or 20% of annual rent.') }}</small>
                        </div>

                        <!-- Annual Pension Contribution -->
                        <div class="mb-3">
                            <label for="pension_contribution" class="form-label">{{ form.pension_contribution.label }}</label>
                            <input type="number" class="form-control income-input" id="pension_contribution" name="pension_contribution" min="0" max="10000000000" step="0.01" placeholder="40000.00" value="{{ form.pension_contribution.data or '' }}">
                            {% if form.pension_contribution.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.pension_contribution.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ t('tax_pension_help', default='Enter your annual pension contribution. Defaults to 8% of income for employees if left blank.') }}</small>
                        </div>

                        <!-- Tax Year -->
                        <div class="mb-3">
                            <label for="tax_year" class="form-label">{{ form.tax_year.label }}</label>
                            <input type="text" class="form-control" id="tax_year" name="tax_year" placeholder="{{ current_year }}" value="{{ form.tax_year.data or current_year }}">
                            {% if form.tax_year.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.tax_year.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ t('tax_year_help', default='Enter the tax year for this calculation (e.g., 2025)') }}</small>
                        </div>

                        <!-- Entity Type -->
                        <div class="mb-3">
                            <label for="entity_type" class="form-label">{{ form.entity_type.label }}</label>
                            <select class="form-select" id="entity_type" name="entity_type">
                                <option value="sole_proprietor" {% if form.entity_type.data == 'sole_proprietor' %}selected{% endif %}>{{ t('tax_entity_sole_proprietor', default='Sole Proprietor') }}</option>
                                <option value="limited_liability" {% if form.entity_type.data == 'limited_liability' %}selected{% endif %}>{{ t('tax_entity_limited_liability', default='Limited Liability') }}</option>
                            </select>
                            {% if form.entity_type.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.entity_type.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ t('tax_entity_type_help', default='Select your business entity type') }}</small>
                        </div>

                        <!-- Deductions -->
                        <div class="mb-3">
                            <label class="form-label">{{ t('tax_deductions', default='Deductions') }}</label>
                            <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="addDeduction()">{{ t('tax_add_deduction', default='Add Deduction') }}</button>
                            <div id="deductions-container">
                                {% for item in form.deductions.entries %}
                                    <div class="deduction-entry card p-3 mb-2">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="form-label">{{ t('tax_item_name', default='Deduction Name') }}</label>
                                                {{ item.form.name(class="form-control", type="text", maxlength="50", placeholder=t('tax_deduction_placeholder', default='e.g., Charity Donation'), value=item.form.name.data or '') }}
                                                {% if item.form.name.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in item.form.name.errors %}
                                                            {{ t(error, default=error) }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">{{ t('tax_item_amount', default='Amount (NGN)') }}</label>
                                                {{ item.form.amount(class="form-control deduction-input", type="number", min="0", max="10000000000", step="0.01", placeholder="50000.00", value=item.form.amount.data or '') }}
                                                {% if item.form.amount.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in item.form.amount.errors %}
                                                            {{ t(error, default=error) }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">{{ t('tax_item_category', default='Category') }}</label>
                                                {{ item.form.category(class="form-control deduction-input", value=item.form.category.data or '') }}
                                                {% if item.form.category.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in item.form.category.errors %}
                                                            {{ t(error, default=error) }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">{{ t('tax_item_note', default='Note') }} {{ t('tax_optional', default='(Optional)') }}</label>
                                                {{ item.form.note(class="form-control", type="text", maxlength="200", placeholder=t('tax_note_placeholder', default='Additional details'), value=item.form.note.data or '') }}
                                                {% if item.form.note.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in item.form.note.errors %}
                                                            {{ t(error, default=error) }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                <button type="button" class="btn btn-danger btn-sm" onclick="removeDeduction(this)">{{ t('general_remove', default='Remove') }}</button>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if not form.deductions.entries %}
                                <p class="text-muted">{{ t('tax_no_deductions', default='No deductions added yet. Click "Add Deduction" to get started.') }}</p>
                            {% endif %}
                            {% if form.deductions.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.deductions.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Form Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('tax.index') }}" class="btn btn-secondary">{{ t('general_back', default='Back') }}</a>
                            <div>
                                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#taxBreakdownModal">{{ t('tax_view_breakdown', default='View Breakdown') }}</button>
                                <button type="submit" class="btn btn-primary">{{ t('tax_calculate', default='Calculate Tax') }}</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Summary and Insights -->
        <div class="col-lg-4">
            <!-- Tax Summary -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">{{ t('tax_summary', default='Tax Summary') }}</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>{{ t('tax_annual_income', default='Annual Income') }}:</span>
                            <span id="summary-income">{{ latest_calculation.income or '0.00' }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>{{ t('tax_total_deductions', default='Total Deductions') }}:</span>
                            <span id="summary-deductions">{{ latest_calculation.deductions | sum(attribute='amount') | format_currency if latest_calculation.deductions else '0.00' }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>{{ t('tax_taxable_income', default='Taxable Income') }}:</span>
                            <span id="summary-taxable-income">{{ latest_calculation.taxable_income or '0.00' }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>{{ t('tax_total_tax', default='Total Tax') }}:</span>
                            <span id="summary-total-tax">{{ latest_calculation.total_tax or '0.00' }}</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Tips -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">{{ t('tax_tips', default='Tips') }}</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% if tips %}
                            {% for tip in tips %}
                                <li class="list-group-item">{{ t(tip, default=tip) }}</li>
                            {% endfor %}
                        {% else %}
                            <li class="list-group-item">{{ t('tax_tip_review_deductions', default='Review all possible deductions to reduce taxable income') }}</li>
                            <li class="list-group-item">{{ t('tax_tip_file_early', default='File your taxes early to avoid penalties') }}</li>
                            <li class="list-group-item">{{ t('tax_tip_keep_records', default='Keep detailed records of all deductible expenses') }}</li>
                            <li class="list-group-item">{{ t('tax_tip_consult_expert', default='Consult a tax professional for complex situations') }}</li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <!-- Taxation Knowledge -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">{{ t('tax_information_title', default='Taxation Knowledge') }}</h5>
                </div>
                <div class="card-body">
                    {% if latest_calculation.entity_type == 'limited_liability' %}
                        <!-- CIT Information -->
                        <h6>{{ t('tax_cit_rates_title', default='Companies Income Tax (CIT) Rates') }}</h6>
                        <div class="alert alert-success">
                            <h6 class="mb-2">{{ t('tax_small_company_exemption', default='Small Company Exemption') }}</h6>
                            <p class="mb-1"><strong>₦0 - ₦50,000,000:</strong> 0% {{ t('tax_rate', default='tax rate') }}</p>
                            <small class="text-muted">{{ t('tax_small_company_note', default='Companies with annual revenue of ₦50 million or less are exempt from CIT') }}</small>
                        </div>
                        <div class="alert alert-warning">
                            <h6 class="mb-2">{{ t('tax_large_company_rate', default='Large Company Rate') }}</h6>
                            <p class="mb-1"><strong>Above ₦50,000,000:</strong> 30% {{ t('tax_rate', default='tax rate') }}</p>
                            <small class="text-muted">{{ t('tax_large_company_note', default='Companies with annual revenue above ₦50 million pay 30% tax on taxable income') }}</small>
                        </div>
                        <hr>
                        <h6>{{ t('tax_cit_deductions_title', default='CIT Deductions') }}</h6>
                        <p class="small text-muted">
                            {{ t('tax_cit_deductions_description', default='For CIT purposes, all legitimate business expenses are generally deductible from revenue to determine taxable income.') }}
                        </p>
                    {% else %}
                        <!-- PIT Information -->
                        <h6>{{ t('tax_progressive_tax_rates_title', default='Progressive Tax Rates (NTA 2025)') }}</h6>
                        <ul class="list-unstyled">
                            <li><strong>₦0 - ₦800,000:</strong> 0%</li>
                            <li><strong>₦800,001 - ₦3,000,000:</strong> 15%</li>
                            <li><strong>₦3,000,001 - ₦12,000,000:</strong> 18%</li>
                            <li><strong>₦12,000,001 - ₦25,000,000:</strong> 21%</li>
                            <li><strong>₦25,000,001 - ₦50,000,000:</strong> 23%</li>
                            <li><strong>Above ₦50,000,000:</strong> 25%</li>
                        </ul>
                        <hr>
                        <h6>{{ t('tax_rent_relief_title', default='Rent Relief') }}</h6>
                        <p class="small text-muted">
                            {{ t('tax_rent_relief_description', default='You can claim rent relief equal to the lower of ₦500,000 or 20% of your annual rent.') }}
                        </p>
                        <hr>
                        <h6>{{ t('tax_four_step_process_title', default='Four-Step Tax Calculation') }}</h6>
                        <div class="step-info mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-success me-2">1</span>
                                <strong>{{ t('tax_step1_title', default='Net Business Profit') }}</strong>
                            </div>
                            <p class="small text-muted mb-0">{{ t('tax_step1_info', default='Income minus main business expenses (e.g., office admin, staff wages)') }}</p>
                        </div>
                        <div class="step-info mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-info me-2">2</span>
                                <strong>{{ t('tax_step2_title', default='Statutory Deductions') }}</strong>
                            </div>
                            <p class="small text-muted mb-0">{{ t('tax_step2_info', default='Subtract statutory contributions (e.g., pension)') }}</p>
                        </div>
                        <div class="step-info mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-warning me-2">3</span>
                                <strong>{{ t('tax_step3_title', default='Rent Relief') }}</strong>
                            </div>
                            <p class="small text-muted mb-0">{{ t('tax_step3_info', default='Apply rent relief (max ₦500,000 or 20% of annual rent)') }}</p>
                        </div>
                        <div class="step-info mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-primary me-2">4</span>
                                <strong>{{ t('tax_step4_title', default='Progressive Tax') }}</strong>
                            </div>
                            <p class="small text-muted mb-0">{{ t('tax_step4_info', default='Apply NTA 2025 progressive tax bands') }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tax Breakdown Modal -->
    <div class="modal fade" id="taxBreakdownModal" tabindex="-1" aria-labelledby="taxBreakdownModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taxBreakdownModalLabel">{{ t('tax_breakdown', default='Tax Breakdown') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if not latest_calculation.calculation_details %}
                        <p>{{ t('tax_breakdown_unavailable', default='Calculate your tax to see the detailed breakdown.') }}</p>
                    {% else %}
                        {% if latest_calculation.entity_type == 'sole_proprietor' %}
                            <h6>{{ t('tax_step1_net_business_profit', default='Step 1: Net Business Profit') }}</h6>
                            <p>{{ t('tax_total_income', default='Total Income') }}: {{ latest_calculation.calculation_details.step1_net_business_profit.total_income | format_currency }}</p>
                            <p>{{ t('tax_total_deductible_expenses', default='Total Deductible Expenses') }}: {{ latest_calculation.calculation_details.step1_net_business_profit.total_deductible_expenses | format_currency }}</p>
                            <p>{{ t('tax_net_business_profit', default='Net Business Profit') }}: {{ latest_calculation.calculation_details.step1_net_business_profit.net_business_profit | format_currency }}</p>
                            <h6>{{ t('tax_step2_statutory_deductions', default='Step 2: Statutory Deductions') }}</h6>
                            <p>{{ t('tax_statutory_expenses', default='Statutory Contributions') }}: {{ latest_calculation.calculation_details.step2_statutory_deductions.statutory_contributions_expenses | format_currency }}</p>
                            <p>{{ t('tax_adjusted_profit', default='Adjusted Profit') }}: {{ latest_calculation.calculation_details.step2_statutory_deductions.adjusted_profit_after_statutory | format_currency }}</p>
                            <h6>{{ t('tax_step3_rent_relief', default='Step 3: Rent Relief') }}</h6>
                            <p>{{ t('tax_rent_relief', default='Rent Relief') }}: {{ latest_calculation.calculation_details.step3_rent_relief.calculated_rent_relief | format_currency }}</p>
                            <p>{{ t('tax_taxable_income', default='Taxable Income') }}: {{ latest_calculation.calculation_details.step3_rent_relief.taxable_income_after_rent_relief | format_currency }}</p>
                            <h6>{{ t('tax_step4_progressive_tax', default='Step 4: Progressive Tax') }}</h6>
                            {% for band in latest_calculation.calculation_details.step4_progressive_tax.tax_band_breakdown %}
                                <p>{{ band.band_description }}: {{ band.tax_in_band | format_currency }}</p>
                            {% endfor %}
                            <p>{{ t('tax_total_tax_liability', default='Total Tax Liability') }}: {{ latest_calculation.calculation_details.step4_progressive_tax.total_tax_liability | format_currency }}</p>
                        {% else %}
                            <h6>{{ t('tax_cit_calculation', default='CIT Calculation') }}</h6>
                            <p>{{ t('tax_total_revenue', default='Total Revenue') }}: {{ latest_calculation.calculation_details.total_revenue | format_currency }}</p>
                            <p>{{ t('tax_taxable_income', default='Taxable Income') }}: {{ latest_calculation.calculation_details.taxable_income | format_currency }}</p>
                            <p>{{ t('tax_tax_rate', default='Tax Rate') }}: {{ latest_calculation.calculation_details.tax_rate | float * 100 }}%</p>
                            <p>{{ t('tax_total_tax_liability', default='Total Tax Liability') }}: {{ latest_calculation.calculation_details.tax_liability | format_currency }}</p>
                            {% if latest_calculation.calculation_details.exemption_applied %}
                                <p>{{ t('tax_exemption_note', default='Exemption Applied') }}: {{ latest_calculation.calculation_details.exemption_reason }}</p>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_close', default='Close') }}</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let deductionIndex = {{ form.deductions.entries|length }};

    const deductionCategories = [
        {value: 'office_admin', label: '{{ t("tax_category_office_admin", default="Office Administration") | e }}'},
        {value: 'staff_wages', label: '{{ t("tax_category_staff_wages", default="Staff Wages") | e }}'},
        {value: 'business_travel', label: '{{ t("tax_category_business_travel", default="Business Travel") | e }}'},
        {value: 'rent_utilities', label: '{{ t("tax_category_rent_utilities", default="Rent and Utilities") | e }}'},
        {value: 'marketing_sales', label: '{{ t("tax_category_marketing_sales", default="Marketing and Sales") | e }}'},
        {value: 'cogs', label: '{{ t("tax_category_cogs", default="Cost of Goods Sold") | e }}'},
        {value: 'statutory_contributions', label: '{{ t("tax_category_statutory_contributions", default="Statutory Contributions") | e }}'}
    ];

    window.addDeduction = function() {
        if (deductionIndex >= 20) {
            showAlert('warning', '{{ t("tax_max_deductions", default="Maximum of 20 deductions allowed.") | e }}');
            return;
        }
        const container = document.getElementById('deductions-container');
        const newEntry = document.createElement('div');
        newEntry.className = 'deduction-entry card p-3 mb-2';
        newEntry.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">{{ t('tax_item_name', default='Deduction Name') }}</label>
                    <input type="text" class="form-control" name="deductions-${deductionIndex}-name" maxlength="50" placeholder="{{ t('tax_deduction_placeholder', default='e.g., Charity Donation') | e }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ t('tax_item_amount', default='Amount (NGN)') }}</label>
                    <input type="number" class="form-control deduction-input" name="deductions-${deductionIndex}-amount" min="0" max="10000000000" step="0.01" placeholder="50000.00">
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ t('tax_item_category', default='Category') }}</label>
                    <select class="form-control deduction-input" name="deductions-${deductionIndex}-category">
                        ${deductionCategories.map(cat => `<option value="${cat.value}">${cat.label}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ t('tax_item_note', default='Note') }} {{ t('tax_optional', default='(Optional)') }}</label>
                    <input type="text" class="form-control" name="deductions-${deductionIndex}-note" maxlength="200" placeholder="{{ t('tax_note_placeholder', default='Additional details') | e }}">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeDeduction(this)">{{ t('general_remove', default='Remove') }}</button>
                </div>
            </div>
        `;
        container.appendChild(newEntry);
        deductionIndex++;
        updateSummary();
    };

    window.removeDeduction = function(button) {
        button.closest('.deduction-entry').remove();
        updateSummary();
    };

    function updateSummary() {
        const incomeInput = parseFloat(document.getElementById('income').value) || 0;
        const rentInput = parseFloat(document.getElementById('rent_expenses').value) || 0;
        const pensionInput = parseFloat(document.getElementById('pension_contribution').value) || (incomeInput * 0.08);
        const deductionInputs = document.querySelectorAll('.deduction-input[type="number"]');
        let totalDeductions = rentInput + pensionInput;
        deductionInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            totalDeductions += value;
        });
        const taxableIncome = Math.max(0, incomeInput - totalDeductions);

        document.getElementById('summary-income').textContent = incomeInput.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        document.getElementById('summary-deductions').textContent = totalDeductions.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        document.getElementById('summary-taxable-income').textContent = taxableIncome.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        document.getElementById('summary-total-tax').textContent = '0.00';
    }

    function showAlert(type, message) {
        const alertContainer = document.createElement('div');
        alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
        alertContainer.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.container').prepend(alertContainer);
        setTimeout(() => alertContainer.remove(), 5000);
    }

    document.getElementById('tax-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

        fetch('{{ url_for("tax.new") }}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json().then(data => ({ status: response.status, data })))
        .then(({ status, data }) => {
            if (status === 200 && data.success) {
                showAlert('success', data.message);
                window.location.href = '{{ url_for("tax.dashboard") }}';
            } else {
                showAlert('danger', data.message || '{{ t("tax_calculation_error", default="Error calculating tax.") | e }}');
                if (data.errors) {
                    Object.keys(data.errors).forEach(field => {
                        const fieldElement = document.querySelector(`[name="${field}"]`);
                        if (fieldElement) {
                            fieldElement.classList.add('is-invalid');
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'invalid-feedback d-block';
                            errorDiv.textContent = data.errors[field].join(', ');
                            fieldElement.parentNode.appendChild(errorDiv);
                        }
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', '{{ t("tax_calculation_error", default="Error calculating tax.") | e }}');
        });
    });

    document.querySelectorAll('.income-input, .deduction-input').forEach(input => {
        input.addEventListener('input', updateSummary);
    });

    updateSummary();
});
</script>

{% block styles %}
<style>
    .deduction-entry .card {
        transition: all 0.2s ease;
    }
    .deduction-entry .card:hover {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .border-success { border-color: #28a745 !important; }
    .border-info { border-color: #17a2b8 !important; }
    .border-warning { border-color: #ffc107 !important; }
    .bg-success { background-color: #28a745 !important; }
    .bg-info { background-color: #17a2b8 !important; }
    .bg-warning { background-color: #ffc107 !important; }
    .bg-primary { background-color: #007bff !important; }
    .form-control:focus, .form-select:focus, .btn:focus {
        outline: 3px solid #0066cc;
        outline-offset: 2px;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.3);
    }
    .badge.bg-success { background-color: #155724 !important; color: #ffffff !important; }
    .badge.bg-info { background-color: #0c5460 !important; color: #ffffff !important; }
    .badge.bg-warning { background-color: #856404 !important; color: #ffffff !important; }
    .alert-warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
    #taxBreakdownModal .modal-body { max-height: 60vh; overflow-y: auto; }
    #taxBreakdownModal .modal-dialog { max-width: 800px; }
</style>
{% endblock %}
{% endblock %}
