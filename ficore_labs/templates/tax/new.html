{% extends "base.html" %}
{% block title %}{{ t('tax_calculate_new', default='Calculate Tax') }}{% endblock %}
{% block content %}
<!-- Add CSRF meta tag for AJAX submissions -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container mt-4">
    {% set tool_name = 'tax_calculate_new' %}
    {% set tool_icon = 'fa-calculator' %}
    {% set subtitle = t('tax_calculate_description', default='Enter your income and deductions to calculate your tax liability') %}
    {% include 'tool_header.html' %}

    <!-- Navigation Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('tax.index') }}">{{ t('tax_calculator_title', default='Tax Calculator') }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ t('tax_calculate_new', default='Calculate Tax') }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form id="tax-form" method="POST" action="{{ url_for('tax.new') }}">
                        {{ form.csrf_token }}

                        <!-- Annual Income -->
                        <div class="mb-3">
                            <label for="income" class="form-label">{{ form.income.label }}</label>
                            <input type="number" class="form-control income-input" id="income" name="income" min="0" max="10000000000" step="0.01" placeholder="500000.00" value="{{ form.income.data or '' }}">
                            {% if form.income.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.income.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ t('tax_income_help', default='Enter your total annual income before deductions') }}</small>
                        </div>

                        <!-- Tax Year -->
                        <div class="mb-3">
                            <label for="tax_year" class="form-label">{{ form.tax_year.label }}</label>
                            <input type="text" class="form-control" id="tax_year" name="tax_year" placeholder="2025" value="{{ form.tax_year.data or datetime.now().year }}">
                            {% if form.tax_year.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.tax_year.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ t('tax_year_help', default='Enter the tax year for this calculation (e.g., 2025)') }}</small>
                        </div>

                        <!-- Entity Type -->
                        <div class="mb-3">
                            <label for="entity_type" class="form-label">{{ form.entity_type.label }}</label>
                            <select class="form-select" id="entity_type" name="entity_type">
                                <option value="sole_proprietor" {% if form.entity_type.data == 'sole_proprietor' %}selected{% endif %}>{{ t('tax_entity_sole_proprietor', default='Sole Proprietor') }}</option>
                                <option value="limited_liability" {% if form.entity_type.data == 'limited_liability' %}selected{% endif %}>{{ t('tax_entity_limited_liability', default='Limited Liability') }}</option>
                            </select>
                            {% if form.entity_type.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.entity_type.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ t('tax_entity_type_help', default='Select your business entity type') }}</small>
                        </div>

                        <!-- Deductions -->
                        <div class="mb-3">
                            <label class="form-label">{{ t('tax_deductions', default='Deductions') }}</label>
                            <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="addDeduction()">{{ t('tax_add_deduction', default='Add Deduction') }}</button>
                            <div id="deductions-container">
                                {% for item in form.deductions.entries %}
                                    <div class="deduction-entry card p-3 mb-2">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">{{ t('tax_item_name', default='Deduction Name') }}</label>
                                                {{ item.form.name(class="form-control", type="text", maxlength="50", placeholder=t('tax_deduction_placeholder', default='e.g., Pension, Charity'), value=item.form.name.data or '') }}
                                                {% if item.form.name.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in item.form.name.errors %}
                                                            {{ t(error, default=error) }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">{{ t('tax_amount', default='Amount') }}</label>
                                                {{ item.form.amount(class="form-control deduction-input", type="number", min="0", max="10000000000", step="0.01", placeholder="50000.00", value=item.form.amount.data or '') }}
                                                {% if item.form.amount.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in item.form.amount.errors %}
                                                            {{ t(error, default=error) }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">{{ t('tax_note', default='Note') }} {{ t('tax_optional', default='(Optional)') }}</label>
                                                {{ item.form.note(class="form-control", type="text", maxlength="200", placeholder=t('tax_note_placeholder', default='Additional details'), value=item.form.note.data or '') }}
                                                {% if item.form.note.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in item.form.note.errors %}
                                                            {{ t(error, default=error) }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                <button type="button" class="btn btn-danger btn-sm" onclick="removeDeduction(this)">{{ t('general_remove', default='Remove') }}</button>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if not form.deductions.entries %}
                                <p class="text-muted">{{ t('tax_no_deductions', default='No deductions added yet. Click "Add Deduction" to get started.') }}</p>
                            {% endif %}
                            {% if form.deductions.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.deductions.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Form Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('tax.index') }}" class="btn btn-secondary">{{ t('general_back', default='Back') }}</a>
                            <div>
                                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#taxBreakdownModal">{{ t('tax_view_breakdown', default='View Breakdown') }}</button>
                                <button type="submit" class="btn btn-primary">{{ t('tax_calculate', default='Calculate Tax') }}</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Summary and Insights -->
        <div class="col-lg-4">
            <!-- Tax Summary -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">{{ t('tax_summary', default='Tax Summary') }}</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>{{ t('tax_income', default='Income') }}:</span>
                            <span id="summary-income">{{ latest_calculation.income or '0.00' }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>{{ t('tax_total_deductions', default='Total Deductions') }}:</span>
                            <span id="summary-deductions">{{ latest_calculation.deductions | sum(attribute='amount') | format_currency if latest_calculation.deductions else '0.00' }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>{{ t('tax_taxable_income', default='Taxable Income') }}:</span>
                            <span id="summary-taxable-income">{{ latest_calculation.taxable_income or '0.00' }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>{{ t('tax_total_tax', default='Total Tax') }}:</span>
                            <span id="summary-total-tax">{{ latest_calculation.total_tax or '0.00' }}</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Tips -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">{{ t('tax_tips', default='Tips') }}</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% if tips %}
                            {% for tip in tips %}
                                <li class="list-group-item">{{ t(tip, default=tip) }}</li>
                            {% endfor %}
                        {% else %}
                            <li class="list-group-item">{{ t('tax_tip_review_deductions', default='Review all possible deductions to reduce taxable income') }}</li>
                            <li class="list-group-item">{{ t('tax_tip_file_early', default='File your taxes early to avoid penalties') }}</li>
                            <li class="list-group-item">{{ t('tax_tip_keep_records', default='Keep detailed records of all deductible expenses') }}</li>
                            <li class="list-group-item">{{ t('tax_tip_consult_expert', default='Consult a tax professional for complex situations') }}</li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <!-- Recent Activity -->
            {% if activities %}
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">{{ t('general_recent_activity', default='Recent Activity') }}</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            {% for activity in activities[:5] %}
                                <li class="list-group-item">
                                    <small class="text-muted">{{ activity.timestamp | format_datetime }}</small><br>
                                    {{ activity.description }}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Tax Breakdown Modal -->
    <div class="modal fade" id="taxBreakdownModal" tabindex="-1" aria-labelledby="taxBreakdownModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taxBreakdownModalLabel">{{ t('tax_breakdown', default='Tax Breakdown') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>{{ t('tax_breakdown_unavailable', default='Calculate your tax to see the detailed breakdown.') }}</p>
                    {% if latest_calculation.calculation_details %}
                        {% if latest_calculation.entity_type == 'sole_proprietor' %}
                            <h6>{{ t('tax_step1_net_business_profit', default='Step 1: Net Business Profit') }}</h6>
                            <p>{{ t('tax_total_income', default='Total Income') }}: {{ latest_calculation.calculation_details.step1_net_business_profit.total_income | format_currency }}</p>
                            <p>{{ t('tax_total_deductible_expenses', default='Total Deductible Expenses') }}: {{ latest_calculation.calculation_details.step1_net_business_profit.total_deductible_expenses | format_currency }}</p>
                            <p>{{ t('tax_net_business_profit', default='Net Business Profit') }}: {{ latest_calculation.calculation_details.step1_net_business_profit.net_business_profit | format_currency }}</p>
                            <h6>{{ t('tax_step2_statutory_deductions', default='Step 2: Statutory Deductions') }}</h6>
                            <p>{{ t('tax_statutory_expenses', default='Statutory Expenses') }}: {{ latest_calculation.calculation_details.step2_statutory_deductions.statutory_legal_expenses | format_currency }}</p>
                            <p>{{ t('tax_adjusted_profit', default='Adjusted Profit') }}: {{ latest_calculation.calculation_details.step2_statutory_deductions.adjusted_profit_after_statutory | format_currency }}</p>
                            <h6>{{ t('tax_step3_rent_relief', default='Step 3: Rent Relief') }}</h6>
                            <p>{{ t('tax_rent_relief', default='Rent Relief') }}: {{ latest_calculation.calculation_details.step3_rent_relief.calculated_rent_relief | format_currency }}</p>
                            <p>{{ t('tax_taxable_income', default='Taxable Income') }}: {{ latest_calculation.calculation_details.step3_rent_relief.taxable_income_after_rent_relief | format_currency }}</p>
                            <h6>{{ t('tax_step4_progressive_tax', default='Step 4: Progressive Tax') }}</h6>
                            {% for band in latest_calculation.calculation_details.step4_progressive_tax.tax_band_breakdown %}
                                <p>{{ band.band_description }}: {{ band.tax_in_band | format_currency }}</p>
                            {% endfor %}
                            <p>{{ t('tax_total_tax_liability', default='Total Tax Liability') }}: {{ latest_calculation.calculation_details.step4_progressive_tax.total_tax_liability | format_currency }}</p>
                        {% else %}
                            <h6>{{ t('tax_cit_calculation', default='CIT Calculation') }}</h6>
                            <p>{{ t('tax_total_revenue', default='Total Revenue') }}: {{ latest_calculation.calculation_details.total_revenue | format_currency }}</p>
                            <p>{{ t('tax_taxable_income', default='Taxable Income') }}: {{ latest_calculation.calculation_details.taxable_income | format_currency }}</p>
                            <p>{{ t('tax_tax_rate', default='Tax Rate') }}: {{ latest_calculation.calculation_details.tax_rate | float * 100 }}%</p>
                            <p>{{ t('tax_total_tax_liability', default='Total Tax Liability') }}: {{ latest_calculation.calculation_details.tax_liability | format_currency }}</p>
                            {% if latest_calculation.calculation_details.exemption_applied %}
                                <p>{{ t('tax_exemption_note', default='Exemption Applied') }}: {{ latest_calculation.calculation_details.exemption_reason }}</p>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_close', default='Close') }}</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let deductionIndex = {{ form.deductions.entries|length }};

    // Add new deduction field
    window.addDeduction = function() {
        if (deductionIndex >= 20) {
            showAlert('warning', '{{ t("tax_max_deductions", default="Maximum of 20 deductions allowed.") | e }}');
            return;
        }
        const container = document.getElementById('deductions-container');
        const newEntry = document.createElement('div');
        newEntry.className = 'deduction-entry card p-3 mb-2';
        newEntry.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">{{ t('tax_item_name', default='Deduction Name') }}</label>
                    <input type="text" class="form-control" name="deductions-${deductionIndex}-name" maxlength="50" placeholder="{{ t('tax_deduction_placeholder', default='e.g., Pension, Charity') | e }}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">{{ t('tax_amount', default='Amount') }}</label>
                    <input type="number" class="form-control deduction-input" name="deductions-${deductionIndex}-amount" min="0" max="10000000000" step="0.01" placeholder="50000.00">
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ t('tax_note', default='Note') }} {{ t('tax_optional', default='(Optional)') }}</label>
                    <input type="text" class="form-control" name="deductions-${deductionIndex}-note" maxlength="200" placeholder="{{ t('tax_note_placeholder', default='Additional details') | e }}">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeDeduction(this)">{{ t('general_remove', default='Remove') }}</button>
                </div>
            </div>
        `;
        container.appendChild(newEntry);
        deductionIndex++;
        updateSummary();
    };

    // Remove deduction field
    window.removeDeduction = function(button) {
        button.closest('.deduction-entry').remove();
        updateSummary();
    };

    // Update tax summary dynamically
    function updateSummary() {
        const incomeInput = document.getElementById('income').value || 0;
        const deductionInputs = document.querySelectorAll('.deduction-input');
        let totalDeductions = 0;
        deductionInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            totalDeductions += value;
        });
        const taxableIncome = Math.max(0, incomeInput - totalDeductions);

        document.getElementById('summary-income').textContent = parseFloat(incomeInput).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        document.getElementById('summary-deductions').textContent = totalDeductions.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        document.getElementById('summary-taxable-income').textContent = taxableIncome.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        // Total tax remains 0 until calculation is performed
        document.getElementById('summary-total-tax').textContent = '0.00';
    }

    // Show alert messages
    function showAlert(type, message) {
        const alertContainer = document.createElement('div');
        alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
        alertContainer.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.container').prepend(alertContainer);
        setTimeout(() => alertContainer.remove(), 5000);
    }

    // Handle form submission via AJAX
    document.getElementById('tax-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

        fetch('{{ url_for("tax.new") }}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json().then(data => ({ status: response.status, data })))
        .then(({ status, data }) => {
            if (status === 200 && data.success) {
                showAlert('success', data.message);
                window.location.href = '{{ url_for("tax.dashboard") }}';
            } else {
                showAlert('danger', data.message || '{{ t("tax_calculation_error", default="Error calculating tax.") | e }}');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', '{{ t("tax_calculation_error", default="Error calculating tax.") | e }}');
        });
    });

    // Update summary on input change
    document.querySelectorAll('.income-input, .deduction-input').forEach(input => {
        input.addEventListener('input', updateSummary);
    });
});
</script>
{% endblock %}
