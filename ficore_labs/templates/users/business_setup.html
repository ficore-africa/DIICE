{% extends 'base.html' %}
{% block title %}{{ t('general_business_setup', default='Business Setup') }} - FiCore{% endblock %}
{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <a href="{{ url_for('users.logout') }}" class="profile-back-arrow">←</a>
        <h1 class="profile-section-heading">{{ t('general_business_setup', default='Business Setup') }}</h1>
    </div>

    {% if trial_days_remaining > 0 %}
    <div class="profile-card profile-account-type-card">
        <div class="profile-card-body">
            <p class="profile-text">
                {{ t('settings_trial_days_remaining', default='Trial Days Remaining') }}: 
                <strong>{{ trial_days_remaining }}</strong>
                <span class="profile-info-icon" title="{{ t('settings_trial_info', default='Your trial gives you full access to FiCore features. Subscribe to continue after the trial ends.') }}">ⓘ</span>
            </p>
        </div>
    </div>
    {% endif %}

    <section class="profile-section">
        <div class="profile-card">
            <div class="profile-card-body">
                <form method="POST" action="{{ url_for('users.setup_wizard') }}" id="business-setup-form">
                    {{ form.csrf_token }}

                    <!-- Progress Indicator -->
                    <div class="profile-progress">
                        <div class="profile-progress-step active" data-step="1">
                            <span class="profile-step-number">1</span>
                            <span>{{ t('general_business_information', default='Business Information') }}</span>
                        </div>
                        <div class="profile-progress-step" data-step="2">
                            <span class="profile-step-number">2</span>
                            <span>{{ t('general_contact_preferences', default='Contact & Preferences') }}</span>
                        </div>
                        <div class="profile-progress-step" data-step="3">
                            <span class="profile-step-number">3</span>
                            <span>{{ t('general_terms', default='Terms') }}</span>
                        </div>
                    </div>

                    <!-- Step 1: Business Information -->
                    <div class="profile-step-content" id="step-1">
                        <h2 class="profile-section-heading">{{ t('general_business_information', default='Business Information') }}</h2>
                        <div class="profile-form-group">
                            <label for="business_name" class="profile-form-label">{{ t('general_business_name', default='Business Name') }}</label>
                            {{ form.business_name(placeholder=t('settings_business_name_placeholder', default='Your Business Name'), class='profile-form-control') }}
                            {% if form.business_name.errors %}
                                {% for error in form.business_name.errors %}
                                    <p class="profile-text-danger">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="profile-form-group">
                            <label for="address" class="profile-form-label">{{ t('general_address', default='Address') }}</label>
                            {{ form.address(placeholder=t('settings_business_address_placeholder', default='Your Business Address'), class='profile-form-control') }}
                            {% if form.address.errors %}
                                {% for error in form.address.errors %}
                                    <p class="profile-text-danger">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="profile-form-group">
                            <label for="industry" class="profile-form-label">{{ t('general_industry', default='Industry') }}</label>
                            {{ form.industry(class='profile-form-control') }}
                            {% if form.industry.errors %}
                                {% for error in form.industry.errors %}
                                    <p class="profile-text-danger">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="profile-form-group">
                            <label for="products_services" class="profile-form-label">{{ t('general_products_services', default='Products/Services') }}</label>
                            {{ form.products_services(placeholder=t('settings_products_services_placeholder', default='e.g., Clothing, Consulting'), class='profile-form-control') }}
                            {% if form.products_services.errors %}
                                {% for error in form.products_services.errors %}
                                    <p class="profile-text-danger">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="profile-text-center">
                            <button type="button" class="profile-btn profile-btn-primary" onclick="nextStep(2)">{{ t('general_next', default='Next') }}</button>
                            {{ form.back(class='profile-btn profile-btn-secondary') }}
                        </div>
                    </div>

                    <!-- Step 2: Contact and Preferences -->
                    <div class="profile-step-content" id="step-2" style="display: none;">
                        <h2 class="profile-section-heading">{{ t('general_contact_preferences', default='Contact & Preferences') }}</h2>
                        <div class="profile-form-group">
                            <label for="phone_number" class="profile-form-label">{{ t('general_phone_number', default='Phone Number') }}</label>
                            {{ form.phone_number(placeholder=t('settings_phone_placeholder', default='+234xxxxxxxxx'), class='profile-form-control') }}
                            {% if form.phone_number.errors %}
                                {% for error in form.phone_number.errors %}
                                    <p class="profile-text-danger">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="profile-form-group">
                            <label for="language" class="profile-form-label">{{ t('general_language', default='Language') }}</label>
                            {{ form.language(class='profile-form-control') }}
                            {% if form.language.errors %}
                                {% for error in form.language.errors %}
                                    <p class="profile-text-danger">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="profile-form-group">
                            <label for="goals" class="profile-form-label">{{ t('general_main_goal', default="What's your main goal?") }}</label>
                            <div class="profile-form-check-group">
                                {% for choice in form.goals %}
                                    <div class="profile-form-check">
                                        {{ choice(class='profile-form-check-input') }}
                                        {{ choice.label(class='profile-form-check-label') }}
                                    </div>
                                {% endfor %}
                                {% if form.goals.errors %}
                                    {% for error in form.goals.errors %}
                                        <p class="profile-text-danger">{{ error }}</p>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        <div class="profile-text-center">
                            <button type="button" class="profile-btn profile-btn-primary" onclick="nextStep(3)">{{ t('general_next', default='Next') }}</button>
                            <button type="button" class="profile-btn profile-btn-secondary" onclick="prevStep(1)">{{ t('general_previous', default='Previous') }}</button>
                        </div>
                    </div>

                    <!-- Step 3: Terms and Submission -->
                    <div class="profile-step-content" id="step-3" style="display: none;">
                        <h2 class="profile-section-heading">{{ t('general_terms', default='Terms') }}</h2>
                        <div class="profile-form-group">
                            <div class="profile-form-check">
                                {{ form.terms(class='profile-form-check-input') }}
                                <label for="terms" class="profile-form-check-label">
                                    {{ t('general_terms', default='I accept the Terms and Conditions') }}
                                    <a href="{{ url_for('general_bp.terms') }}" target="_blank">{{ t('general_terms_link', default='View Terms') }}</a>
                                </label>
                                {% if form.terms.errors %}
                                    {% for error in form.terms.errors %}
                                        <p class="profile-text-danger">{{ error }}</p>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        <div class="profile-text-center">
                            {{ form.submit(class='profile-btn profile-btn-primary') }}
                            <button type="button" class="profile-btn profile-btn-secondary" onclick="prevStep(2)">{{ t('general_previous', default='Previous') }}</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <div class="profile-grid">
        <button class="profile-btn profile-btn-danger" onclick="location.href='{{ url_for('users.logout') }}'">
            <i class="bi bi-box-arrow-right profile-icon"></i> {{ t('general_logout', default='Log out') }}
        </button>
    </div>
</div>

<script>
    function showStep(stepNumber) {
        document.querySelectorAll('.profile-step-content').forEach(step => {
            step.style.display = 'none';
        });
        document.getElementById(`step-${stepNumber}`).style.display = 'block';

        document.querySelectorAll('.profile-progress-step').forEach(step => {
            step.classList.remove('active');
        });
        document.querySelector(`.profile-progress-step[data-step="${stepNumber}"]`).classList.add('active');
    }

    function nextStep(stepNumber) {
        // Basic client-side validation for the current step
        const currentStep = document.querySelector('.profile-step-content:not([style*="display: none"])');
        const inputs = currentStep.querySelectorAll('input, select, textarea');
        let isValid = true;

        inputs.forEach(input => {
            if (input.required && !input.value.trim()) {
                isValid = false;
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
            }
        });

        if (stepNumber === 2) {
            const goals = document.querySelectorAll('input[name="goals"]:checked');
            if (goals.length === 0) {
                isValid = false;
                const goalsError = document.querySelector('.profile-form-check-group');
                if (goalsError) {
                    goalsError.insertAdjacentHTML('beforeend', '<p class="profile-text-danger">{{ t('general_select_at_least_one_goal', default='Please select at least one goal.') }}</p>');
                }
            }
        }

        if (isValid) {
            showStep(stepNumber);
        } else {
            alert('{{ t('general_fill_required_fields', default='Please fill out all required fields.') }}');
        }
    }

    function prevStep(stepNumber) {
        // Remove any client-side added error messages
        document.querySelectorAll('.profile-text-danger:not([data-server-error])').forEach(error => error.remove());
        showStep(stepNumber);
    }

    document.addEventListener('DOMContentLoaded', () => {
        showStep(1); // Initialize with first step

        // Mark server-side errors to distinguish from client-side
        document.querySelectorAll('.profile-text-danger').forEach(error => {
            error.setAttribute('data-server-error', 'true');
        });

        // Remove invalid class on input change
        document.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('input', () => {
                input.classList.remove('is-invalid');
            });
        });
    });
</script>
{% endblock %}
