{% extends "base.html" %}

{% block title %}
{{ trans('dashboard_title', default='Dashboard') | escape }}
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-notifications.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-realtime.css') }}">
<script src="{{ url_for('static', filename='js/dashboard-notifications.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/dashboard-realtime.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="container" data-user-id="{{ current_user.id if current_user.is_authenticated else '' }}">
    <!-- Dismissable Notifications Container -->
    <div id="dashboard-notifications-container" class="mb-4">
        <!-- Notifications will be dynamically inserted here -->
    </div>

    <!-- Tax Prep Mode Alert -->
    {% if tax_prep_mode and stats.profit_only is defined %}
    <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
        <i class="bi bi-cash-coin me-2"></i>
        <div>
            <strong>{{ trans('profit_only', default='True Profit:') | escape }}</strong>
            <span class="h4 text-success ms-2">{{ stats.profit_only | format_currency }}</span>
            <br>
            <small class="text-muted">{{ trans('profit_note', default='This is your actual profit after all expenses and inventory costs.') | escape }}</small>
        </div>
    </div>
    {% endif %}

    <!-- Real-time Refresh Controls -->
    {% if current_user.is_authenticated %}
    <div class="refresh-controls">
        <button id="dashboard-refresh-btn" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-arrow-clockwise"></i> {{ trans('general_refresh', default='Refresh') | escape }}
        </button>
        
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="auto-refresh-toggle" checked>
            <label class="form-check-label" for="auto-refresh-toggle">
                {{ trans('auto_refresh', default='Auto-refresh') | escape }}
            </label>
        </div>
        
        <select id="refresh-rate-select" class="form-select form-select-sm">
            <option value="30" selected>{{ trans('refresh_30s', default='30 seconds') | escape }}</option>
            <option value="60">{{ trans('refresh_1m', default='1 minute') | escape }}</option>
            <option value="300">{{ trans('refresh_5m', default='5 minutes') | escape }}</option>
        </select>
        
        <span id="refresh-indicator" class="text-primary">
            <i class="bi bi-arrow-clockwise spin"></i> {{ trans('refreshing', default='Refreshing...') | escape }}
        </span>
        
        <small id="last-refresh-time" class="last-refresh-time"></small>
    </div>
    {% endif %}

    <!-- Tax Prep Mode Toggle -->
    <div class="mb-4">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="taxPrepToggle" {% if tax_prep_mode %}checked{% endif %}>
            <label class="form-check-label" for="taxPrepToggle">
                <i class="bi bi-calculator me-1"></i>
                {{ trans('profit_mode', default='Tax Prep Mode: Show Profit Only') | escape }}
            </label>
        </div>
        <small class="text-muted">{{ trans('true_profit_help', default='This gives you a quick true profit, not all inflows.') | escape }}</small>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggle = document.getElementById('taxPrepToggle');
        toggle.addEventListener('change', function() {
            if (toggle.checked) {
                window.location.href = window.location.pathname + '?tax_prep=1';
            } else {
                window.location.href = window.location.pathname;
            }
        });
    });

    function toggleTaxPrepMode() {
        const currentUrl = new URL(window.location);
        if (currentUrl.searchParams.get('tax_prep') === '1') {
            currentUrl.searchParams.delete('tax_prep');
        } else {
            currentUrl.searchParams.set('tax_prep', '1');
        }
        window.location.href = currentUrl.toString();
    }
    </script>

    <!-- Legacy notifications are now handled by JavaScript -->

    <!-- Download Profit Summary Button -->
    <div class="mb-4">
        <a href="{{ url_for('reports.profit_loss') }}?format=pdf" class="btn btn-outline-success">
            <i class="bi bi-file-earmark-arrow-down me-1"></i>
            {{ trans('download_profit_summary', default='Download Profit Summary (PDF)') | escape }}
        </a>
    </div>

    <!-- Business Finance Stats -->
    {% if current_user.is_authenticated %}
    <div class="row g-3 mb-4">
        <!-- Profit Summary Card -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 dashboard-stat-card profit-summary-card {% if (stats.total_receipts_amount - stats.total_payments_amount) < 0 %}negative{% endif %}">
                <div class="card-body text-center">
                    <div class="text-white mb-2">
                        <i class="bi bi-graph-up-arrow fa-2x"></i>
                    </div>
                    <h6 class="card-title text-white">{{ trans('profit_summary', default='Profit Summary') | escape }}</h6>
                    <p class="card-text">
                        {% if tax_prep_mode and stats.profit_only is defined %}
                            <span id="true-profit" class="h5 text-white profit-summary-value">{{ stats.profit_only | format_currency }}</span><br>
                            <small class="text-white-50">{{ trans('true_profit', default='True Profit') | escape }}</small>
                        {% else %}
                            <span id="gross-profit" class="h5 text-white profit-summary-value">{{ (stats.total_receipts_amount - stats.total_payments_amount) | format_currency }}</span><br>
                            <small class="text-white-50">{{ trans('gross_profit', default='Gross Profit') | escape }}</small>
                        {% endif %}
                    </p>
                    <button class="btn btn-outline-light btn-sm" onclick="toggleTaxPrepMode()">
                        {{ trans('toggle_view', default='Toggle View') | escape }}
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 dashboard-stat-card">
                <div class="card-body text-center">
                    <div class="text-primary mb-2">
                        <i class="bi bi-box-seam fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('inventory_nav_label', default='Inventory') | escape }}</h6>
                    <p class="card-text">
                        <span id="inventory-count" class="h5 text-primary">{{ stats.total_inventory | default('0') }}</span><br>
                        <small class="text-muted"><span id="inventory-cost">{{ stats.total_inventory_cost | format_currency }}</span></small>
                    </p>
                    <a href="{{ url_for('inventory.index') }}" class="btn btn-outline-primary btn-sm">{{ trans('general_view', default='View') | escape }}</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 dashboard-stat-card">
                <div class="card-body text-center">
                    <div class="text-primary mb-2">
                        <i class="bi bi-person-plus-fill fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('general_debtors', default='Debtors') | escape }}</h6>
                    <p class="card-text">
                        <span id="debtors-count" class="h5 text-primary">{{ stats.total_debtors }}</span><br>
                        <small class="text-muted"><span id="debtors-amount">{{ stats.total_debtors_amount | format_currency }}</span></small>
                    </p>
                    <a href="{{ url_for('debtors.index') }}" class="btn btn-outline-primary btn-sm">{{ trans('general_view', default='View') | escape }}</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 dashboard-stat-card">
                <div class="card-body text-center">
                    <div class="text-primary mb-2">
                        <i class="bi bi-person-dash-fill fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('general_creditors', default='Creditors') | escape }}</h6>
                    <p class="card-text">
                        <span id="creditors-count" class="h5 text-primary">{{ stats.total_creditors }}</span><br>
                        <small class="text-muted"><span id="creditors-amount">{{ stats.total_creditors_amount | format_currency }}</span></small>
                    </p>
                    <a href="{{ url_for('creditors.index') }}" class="btn btn-outline-primary btn-sm">{{ trans('general_view', default='View') | escape }}</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 dashboard-stat-card">
                <div class="card-body text-center">
                    <div class="text-success mb-2">
                        <i class="bi bi-cash-stack fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('receipts_money_in', default='Income') | escape }}</h6>
                    <p class="card-text">
                        <span id="receipts-count" class="h5 text-success">{{ stats.total_receipts }}</span><br>
                        <small class="text-muted"><span id="receipts-amount">{{ stats.total_receipts_amount | format_currency }}</span></small>
                    </p>
                    <a href="{{ url_for('receipts.index') }}" class="btn btn-outline-success btn-sm">{{ trans('general_view', default='View') | escape }}</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 dashboard-stat-card">
                <div class="card-body text-center">
                    <div class="text-danger mb-2">
                        <i class="bi bi-wallet2 fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('payments_money_out', default='Expenses') | escape }}</h6>
                    <p class="card-text">
                        <span id="payments-count" class="h5 text-danger">{{ stats.total_payments }}</span><br>
                        <small class="text-muted"><span id="payments-amount">{{ stats.total_payments_amount | format_currency }}</span></small>
                    </p>
                    <a href="{{ url_for('payments.index') }}" class="btn btn-outline-danger btn-sm">{{ trans('general_view', default='View') | escape }}</a>
                </div>
            </div>
        </div>
    </div>

    <!-- User Streak Card -->
    {% if current_user.is_authenticated %}
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-primary mb-2">
                        <i class="bi bi-fire fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('streak_title', default='Streak') | escape }}</h6>
                    <p class="card-text">
                        <span class="h5 text-primary">{{ streak | default(0) }}</span><br>
                        <small class="text-muted">{{ trans('streak_days', default='days of clean record keeping!') | escape }}</small>
                        {% if streak is defined and streak >= 3 %}
                        <span class="badge bg-warning text-dark ms-2">{{ trans('streak_reward', default='Keep it up!') | escape }}</span>
                        {% endif %}
                    </p>
                    <a href="{{ url_for('rewards.index') }}" class="btn btn-outline-primary btn-sm">{{ trans('general_view', default='View') | escape }}</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Reminder Log -->
    {% if show_daily_log_reminder %}
    <div class="mb-4">
        {{ trans('reminder_log_today', default="Have you recorded today’s sales or expenses? Keep your records up to date!") | escape }}
        <a href="{{ url_for('business.home') }}" class="btn btn-sm btn-primary ms-2">{{ trans('log_now', default='Log Now') | escape }}</a>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    {% if can_interact %}
    <div class="mb-4">
        <h3>{{ trans('general_quick_actions', default='Quick Actions') | escape }}</h3>
        <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('inventory.add') }}" class="btn btn-primary">{{ trans('inventory_add', default='Add Inventory Item') | escape }}</a>
            <a href="{{ url_for('creditors.add') }}" class="btn btn-primary">{{ trans('creditors_create_what_you_owe', default='Create What You Owe') | escape }}</a>
            <a href="{{ url_for('debtors.add') }}" class="btn btn-primary">{{ trans('debtors_create_what_they_owe_you', default='Create What They Owe You') | escape }}</a>
            <a href="{{ url_for('payments.add') }}" class="btn btn-primary">{{ trans('payments_add_money_out', default='Add Money Out') | escape }}</a>
            <a href="{{ url_for('receipts.add') }}" class="btn btn-primary">{{ trans('receipts_add_money_in', default='Add Money In') | escape }}</a>
            {% if current_user.role == 'admin' %}
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-warning">{{ trans('admin_dashboard', default='Admin Dashboard') | escape }}</a>
            {% endif %}
        </div>
    </div>
    {% endif %}


    {% else %}
    <div class="text-center py-5">
        <h3>{{ trans('dashboard_welcome_to_ficore', default='Welcome to Business Finance') | escape }}</h3>
        <p class="text-muted">{{ trans('dashboard_please_login', default='Please log in to view your dashboard.') | escape }}</p>
        <a href="{{ url_for('users.login') }}" class="btn btn-primary">{{ trans('general_login', default='Log In') | escape }}</a>
    </div>
    {% endif %}


</div>

<script>
    // JavaScript for dashboard functionality
    document.addEventListener('DOMContentLoaded', function () {
        // Enable Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Pass dashboard data to notification system
        window.dashboardData = {
            inventoryLoss: {{ 'true' if inventory_loss else 'false' }},
            debts: {
                unpaidDebtors: {{ unpaid_debtors | tojson if unpaid_debtors else '[]' }},
                unpaidCreditors: {{ unpaid_creditors | tojson if unpaid_creditors else '[]' }}
            }
        };
    });
</script>
{% endblock %}
