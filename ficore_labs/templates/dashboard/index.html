{% extends "base.html" %}

{% block title %}
{{ trans('dashboard_title', default='Dashboard') | escape }}
{% endblock %}

{% block extra_head %}
<!-- External CSS for dashboard-specific components -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-notifications.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-realtime.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

<!-- External JavaScript for dynamic features -->
<script src="{{ url_for('static', filename='js/dashboard-notifications.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/dashboard-realtime.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="dashboard-container" data-user-id="{{ current_user.id if current_user.is_authenticated else '' | escape }}">
    {% if current_user.is_authenticated %}
    
    <!-- 1. DISMISSABLE NOTIFICATIONS & TAX PREP ALERT -->
    <div id="dashboard-notifications-container" class="mb-4">
        <!-- Notifications will be dynamically inserted here by dashboard-notifications.js -->
    </div>

    {% if tax_prep_mode and stats.profit_only is defined %}
    <div class="dashboard-card dashboard-text-success d-flex align-items-center mb-4">
        <i class="bi bi-cash-coin me-3 h4"></i>
        <div>
            <strong class="me-2">{{ trans('profit_only', default='True Profit (Tax Prep Mode):') | escape }}</strong>
            <span class="h4">{{ stats.profit_only | format_currency }}</span>
            <small class="d-block dashboard-text-muted">{{ trans('profit_note', default='This is your actual profit after all expenses and inventory costs.') | escape }}</small>
        </div>
    </div>
    {% endif %}

    <!-- 2. REAL-TIME REFRESH CONTROLS -->
    <div class="dashboard-card mb-4">
        <div class="dashboard-card-body d-flex align-items-center flex-wrap gap-3">
            <button id="dashboard-refresh-btn" class="dashboard-btn dashboard-btn-primary">
                <i class="bi bi-arrow-clockwise"></i> {{ trans('general_refresh', default='Refresh Now') | escape }}
            </button>
            
            <div class="dashboard-form-group">
                <input class="dashboard-form-check-input" type="checkbox" id="auto-refresh-toggle" checked>
                <label class="dashboard-form-label" for="auto-refresh-toggle">
                    {{ trans('auto_refresh', default='Auto-refresh') | escape }}
                </label>
            </div>
            
            <select id="refresh-rate-select" class="dashboard-form-control" style="width: auto;">
                <option value="30" selected>{{ trans('refresh_30s', default='30 seconds') | escape }}</option>
                <option value="60">{{ trans('refresh_1m', default='1 minute') | escape }}</option>
                <option value="300">{{ trans('refresh_5m', default='5 minutes') | escape }}</option>
            </select>
            
            <span id="refresh-indicator" class="me-3 d-none">
                <i class="bi bi-arrow-clockwise dashboard-spinner"></i> {{ trans('refreshing', default='Refreshing...') | escape }}
            </span>
            
            <small id="last-refresh-time" class="dashboard-text-muted"></small>
        </div>
    </div>

    <!-- 3. TAX PREP TOGGLE AND PDF DOWNLOAD -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div class="dashboard-form-group">
            <input class="dashboard-form-check-input" type="checkbox" id="taxPrepToggle" {% if tax_prep_mode %}checked{% endif %}>
            <label class="dashboard-form-label" for="taxPrepToggle">
                <i class="bi bi-calculator me-1"></i>
                <strong>{{ trans('profit_mode', default='Tax Prep Mode: Show Profit Only') | escape }}</strong>
            </label>
            <small class="d-block dashboard-text-muted">{{ trans('true_profit_help', default='Toggle to view pure profit after costs.') | escape }}</small>
        </div>
        
        <a href="{{ url_for('reports.profit_loss') }}?format=pdf" class="dashboard-btn dashboard-btn-success">
            <i class="bi bi-file-earmark-arrow-down me-1"></i>
            {{ trans('download_profit_summary', default='Download P&L Report (PDF)') | escape }}
        </a>
    </div>

    <!-- 4. BUSINESS FINANCE STATS CARDS -->
    <div class="row g-4 mb-5">
        <!-- Profit Summary Card -->
        {% set profit = (stats.total_receipts_amount - stats.total_payments_amount) %}
        <div class="col-6 col-md-3">
            <div class="dashboard-card dashboard-profit-summary-card {% if profit < 0 %}negative{% endif %}">
                <div class="dashboard-card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-graph-up-arrow fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('profit_summary', default='Profit Summary') | escape }}</h6>
                    <p class="card-text">
                        {% if tax_prep_mode and stats.profit_only is defined %}
                            <span id="true-profit" class="h3">{{ stats.profit_only | format_currency }}</span><br>
                            <small class="dashboard-text-muted">{{ trans('true_profit', default='True Profit') | escape }}</small>
                        {% else %}
                            <span id="gross-profit" class="h3">{{ profit | format_currency }}</span><br>
                            <small class="dashboard-text-muted">{{ trans('gross_profit', default='Gross Profit') | escape }}</small>
                        {% endif %}
                    </p>
                    <button class="dashboard-btn dashboard-btn-outline btn-sm mt-2" onclick="toggleTaxPrepMode()">
                        {{ trans('toggle_view', default='Toggle Profit View') | escape }}
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Inventory Card -->
        <div class="col-6 col-md-3">
            <div class="dashboard-card">
                <div class="dashboard-card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-box-seam fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('inventory_nav_label', default='Inventory') | escape }}</h6>
                    <p class="card-text">
                        <span id="inventory-count" class="h3">{{ stats.total_inventory | default('0') }}</span><br>
                        <small class="dashboard-text-muted">Total Items</small>
                        <span id="inventory-cost" class="d-block">{{ stats.total_inventory_cost | format_currency }}</span>
                    </p>
                    <a href="{{ url_for('inventory.index') }}" class="dashboard-btn dashboard-btn-outline btn-sm">{{ trans('general_view', default='View Details') | escape }}</a>
                </div>
            </div>
        </div>
        
        <!-- Income/Receipts Card -->
        <div class="col-6 col-md-3">
            <div class="dashboard-card">
                <div class="dashboard-card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-cash-stack fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('receipts_money_in', default='Total Income') | escape }}</h6>
                    <p class="card-text">
                        <span id="receipts-amount" class="h3">{{ stats.total_receipts_amount | format_currency }}</span><br>
                        <small class="dashboard-text-muted">{{ trans('receipts_count', default='Total Receipts') | escape }}: <span id="receipts-count">{{ stats.total_receipts | default('0') }}</span></small>
                    </p>
                    <a href="{{ url_for('receipts.index') }}" class="dashboard-btn dashboard-btn-outline btn-sm">{{ trans('general_view', default='View Details') | escape }}</a>
                </div>
            </div>
        </div>
        
        <!-- Expenses/Payments Card -->
        <div class="col-6 col-md-3">
            <div class="dashboard-card">
                <div class="dashboard-card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-wallet2 fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('payments_money_out', default='Total Expenses') | escape }}</h6>
                    <p class="card-text">
                        <span id="payments-amount" class="h3">{{ stats.total_payments_amount | format_currency }}</span><br>
                        <small class="dashboard-text-muted">{{ trans('payments_count', default='Total Payments') | escape }}: <span id="payments-count">{{ stats.total_payments | default('0') }}</span></small>
                    </p>
                    <a href="{{ url_for('payments.index') }}" class="dashboard-btn dashboard-btn-outline btn-sm">{{ trans('general_view', default='View Details') | escape }}</a>
                </div>
            </div>
        </div>
        
        <!-- Debtors Card -->
        <div class="col-6 col-md-3">
            <div class="dashboard-card">
                <div class="dashboard-card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-person-plus-fill fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('general_debtors', default='Money Owed to You') | escape }}</h6>
                    <p class="card-text">
                        <span id="debtors-amount" class="h3">{{ stats.total_debtors_amount | format_currency }}</span><br>
                        <small class="dashboard-text-muted">{{ trans('debtors_count', default='Total Debtors') | escape }}: <span id="debtors-count">{{ stats.total_debtors | default('0') }}</span></small>
                    </p>
                    <a href="{{ url_for('debtors.index') }}" class="dashboard-btn dashboard-btn-outline btn-sm">{{ trans('general_view', default='View Details') | escape }}</a>
                </div>
            </div>
        </div>
        
        <!-- Creditors Card -->
        <div class="col-6 col-md-3">
            <div class="dashboard-card">
                <div class="dashboard-card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-person-dash-fill fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('general_creditors', default='Money You Owe') | escape }}</h6>
                    <p class="card-text">
                        <span id="creditors-amount" class="h3">{{ stats.total_creditors_amount | format_currency }}</span><br>
                        <small class="dashboard-text-muted">{{ trans('creditors_count', default='Total Creditors') | escape }}: <span id="creditors-count">{{ stats.total_creditors | default('0') }}</span></small>
                    </p>
                    <a href="{{ url_for('creditors.index') }}" class="dashboard-btn dashboard-btn-outline btn-sm">{{ trans('general_view', default='View Details') | escape }}</a>
                </div>
            </div>
        </div>
        
        <!-- Streak Card -->
        <div class="col-6 col-md-3">
            <div class="dashboard-card">
                <div class="dashboard-card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-fire fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('streak_title', default='Record Keeping Streak') | escape }}</h6>
                    <p class="card-text">
                        <span class="h3">{{ streak | default(0) }}</span><br>
                        <small class="dashboard-text-muted">{{ trans('streak_days', default='days in a row!') | escape }}</small>
                        {% if streak is defined and streak >= 3 %}
                        <span class="badge bg-success">{{ trans('streak_reward', default='Excellent!') | escape }}</span>
                        {% endif %}
                    </p>
                    <a href="{{ url_for('rewards.index') }}" class="dashboard-btn dashboard-btn-outline btn-sm">{{ trans('general_view', default='View Rewards') | escape }}</a>
                </div>
            </div>
        </div>
        
        <!-- Daily Log Reminder Card -->
        {% if show_daily_log_reminder %}
        <div class="col-6 col-md-3">
            <div class="dashboard-card">
                <div class="dashboard-card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-calendar-check fa-2x"></i>
                    </div>
                    <h6 class="card-title">{{ trans('log_reminder_title', default='Daily Check-In') | escape }}</h6>
                    <p class="card-text">
                        <small class="dashboard-text-muted">{{ trans('reminder_log_today', default="Have you recorded today’s activity?") | escape }}</small>
                    </p>
                    <a href="{{ url_for('business.home') }}" class="dashboard-btn dashboard-btn-primary btn-sm mt-2">{{ trans('log_now', default='Log Now') | escape }}</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- 5. RECENT ACTIVITY SECTIONS -->
    <div class="mb-5">
        <h3 class="dashboard-section-heading">{{ trans('recent_activity', default='Recent Activity') | escape }}</h3>
        <div class="row g-4">
            <!-- Recent Debtors -->
            <div class="col-md-6">
                <div class="dashboard-card">
                    <div class="dashboard-card-body d-flex flex-column">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-person-plus-fill me-2"></i> {{ trans('general_debtors', default='Recent Debtors') | escape }}
                        </h5>
                        {% if recent_debtors %}
                        <div class="dashboard-table-responsive flex-grow-1">
                            <table class="table table-sm table-hover mb-0 dashboard-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>{{ trans('general_date', default='Date') | escape }}</th>
                                        <th>{{ trans('general_name', default='Name') | escape }}</th>
                                        <th class="text-end">{{ trans('general_amount_owed', default='Amount Owed') | escape }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for debtor in recent_debtors[:5] %}
                                    <tr>
                                        <td>{{ debtor.created_at | format_date | escape }}</td>
                                        <td>{{ debtor.name | escape }}</td>
                                        <td class="text-end">{{ debtor.amount_owed | format_currency }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="flex-grow-1 d-flex align-items-center justify-content-center dashboard-text-muted">
                            {{ trans('no_recent_debtors', default='No recent debtors found.') | escape }}
                        </p>
                        {% endif %}
                        <a href="{{ url_for('debtors.index') }}" class="dashboard-btn dashboard-btn-outline btn-sm mt-3 align-self-start">{{ trans('general_view_all', default='View All Debtors') | escape }}</a>
                    </div>
                </div>
            </div>
            
            <!-- Recent Creditors -->
            <div class="col-md-6">
                <div class="dashboard-card">
                    <div class="dashboard-card-body d-flex flex-column">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-person-dash-fill me-2"></i> {{ trans('general_creditors', default='Recent Creditors') | escape }}
                        </h5>
                        {% if recent_creditors %}
                        <div class="dashboard-table-responsive flex-grow-1">
                            <table class="table table-sm table-hover mb-0 dashboard-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>{{ trans('general_date', default='Date') | escape }}</th>
                                        <th>{{ trans('general_name', default='Name') | escape }}</th>
                                        <th class="text-end">{{ trans('general_amount_owed', default='Amount Owed') | escape }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for creditor in recent_creditors[:5] %}
                                    <tr>
                                        <td>{{ creditor.created_at | format_date | escape }}</td>
                                        <td>{{ creditor.name | escape }}</td>
                                        <td class="text-end">{{ creditor.amount_owed | format_currency }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="flex-grow-1 d-flex align-items-center justify-content-center dashboard-text-muted">
                            {{ trans('no_recent_creditors', default='No recent creditors found.') | escape }}
                        </p>
                        {% endif %}
                        <a href="{{ url_for('creditors.index') }}" class="dashboard-btn dashboard-btn-outline btn-sm mt-3 align-self-start">{{ trans('general_view_all', default='View All Creditors') | escape }}</a>
                    </div>
                </div>
            </div>
            
            <!-- Recent Receipts -->
            <div class="col-md-6">
                <div class="dashboard-card">
                    <div class="dashboard-card-body d-flex flex-column">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-arrow-down-left me-2"></i> {{ trans('receipts_money_in', default='Recent Income') | escape }}
                        </h5>
                        {% if recent_receipts %}
                        <div class="dashboard-table-responsive flex-grow-1">
                            <table class="table table-sm table-hover mb-0 dashboard-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>{{ trans('general_date', default='Date') | escape }}</th>
                                        <th>{{ trans('general_party_name', default='Source') | escape }}</th>
                                        <th class="text-end">{{ trans('general_amount', default='Amount') | escape }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for receipt in recent_receipts[:5] %}
                                    <tr>
                                        <td>{{ receipt.created_at | format_date | escape }}</td>
                                        <td>{{ receipt.party_name | escape }}</td>
                                        <td class="text-end">{{ receipt.amount | format_currency }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="flex-grow-1 d-flex align-items-center justify-content-center dashboard-text-muted">
                            {{ trans('no_recent_receipts', default='No recent income recorded.') | escape }}
                        </p>
                        {% endif %}
                        <a href="{{ url_for('receipts.index') }}" class="dashboard-btn dashboard-btn-outline btn-sm mt-3 align-self-start">{{ trans('general_view_all', default='View All Income') | escape }}</a>
                    </div>
                </div>
            </div>
            
            <!-- Recent Payments -->
            <div class="col-md-6">
                <div class="dashboard-card">
                    <div class="dashboard-card-body d-flex flex-column">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-arrow-up-right me-2"></i> {{ trans('payments_money_out', default='Recent Expenses') | escape }}
                        </h5>
                        {% if recent_payments %}
                        <div class="dashboard-table-responsive flex-grow-1">
                            <table class="table table-sm table-hover mb-0 dashboard-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>{{ trans('general_date', default='Date') | escape }}</th>
                                        <th>{{ trans('general_party_name', default='Recipient') | escape }}</th>
                                        <th class="text-end">{{ trans('general_amount', default='Amount') | escape }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payment in recent_payments[:5] %}
                                    <tr>
                                        <td>{{ payment.created_at | format_date | escape }}</td>
                                        <td>{{ payment.party_name | escape }}</td>
                                        <td class="text-end">{{ payment.amount | format_currency }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="flex-grow-1 d-flex align-items-center justify-content-center dashboard-text-muted">
                            {{ trans('no_recent_payments', default='No recent expenses recorded.') | escape }}
                        </p>
                        {% endif %}
                        <a href="{{ url_for('payments.index') }}" class="dashboard-btn dashboard-btn-outline btn-sm mt-3 align-self-start">{{ trans('general_view_all', default='View All Expenses') | escape }}</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 6. QUICK ACTIONS -->
    {% if can_interact %}
    <div class="mb-5">
        <h3 class="dashboard-section-heading">{{ trans('general_quick_actions', default='Quick Actions') | escape }}</h3>
        <div class="d-flex flex-wrap gap-3">
            <a href="{{ url_for('receipts.add') }}" class="dashboard-btn dashboard-btn-success">
                <i class="bi bi-plus-circle me-2"></i> {{ trans('receipts_add_money_in', default='Add Income') | escape }}
            </a>
            <a href="{{ url_for('payments.add') }}" class="dashboard-btn dashboard-btn-danger">
                <i class="bi bi-dash-circle me-2"></i> {{ trans('payments_add_money_out', default='Add Expense') | escape }}
            </a>
            <a href="{{ url_for('inventory.add') }}" class="dashboard-btn dashboard-btn-primary">
                <i class="bi bi-box-seam me-2"></i> {{ trans('inventory_add', default='New Stock') | escape }}
            </a>
            <a href="{{ url_for('debtors.add') }}" class="dashboard-btn dashboard-btn-info">
                <i class="bi bi-person-plus me-2"></i> {{ trans('debtors_create_what_they_owe_you', default='New Debtor') | escape }}
            </a>
            {% if current_user.role == 'admin' %}
            <a href="{{ url_for('admin.dashboard') }}" class="dashboard-btn dashboard-btn-warning">
                <i class="bi bi-shield-lock me-2"></i> {{ trans('admin_dashboard', default='Admin Dashboard') | escape }}
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- 7. LOGGED OUT FALLBACK -->
    <div class="dashboard-card text-center py-5 my-5">
        <div class="dashboard-card-body">
            <h1 class="dashboard-section-heading">{{ trans('dashboard_welcome_to_ficore', default='Welcome to Business Finance Dashboard') | escape }}</h1>
            <p class="fs-4 dashboard-text-muted">{{ trans('dashboard_please_login', default='Log in to access your business statistics, recent activity, and quick action links.') | escape }}</p>
            <a href="{{ url_for('users.login') }}" class="dashboard-btn dashboard-btn-primary btn-lg mt-3">{{ trans('general_login', default='Log In Now') | escape }}</a>
        </div>
    </div>
    {% endif %}
</div>

<!-- 8. PAGE-SPECIFIC JAVASCRIPT -->
<script>
    // Utility function to toggle tax prep mode via URL parameter
    function toggleTaxPrepMode() {
        const currentUrl = new URL(window.location);
        if (currentUrl.searchParams.get('tax_prep') === '1') {
            currentUrl.searchParams.delete('tax_prep');
        } else {
            currentUrl.searchParams.set('tax_prep', '1');
        }
        window.location.href = currentUrl.toString();
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        // --- Initialization ---
        
        // 1. Enable Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // 2. Attach toggle event listener
        const taxPrepToggle = document.getElementById('taxPrepToggle');
        if (taxPrepToggle) {
            taxPrepToggle.addEventListener('change', toggleTaxPrepMode);
        }
        
        // 3. Pass dashboard data to notification system (if authenticated)
        window.dashboardData = {
            inventoryLoss: {{ 'true' if inventory_loss else 'false' }},
            debts: {
                unpaidDebtors: {{ unpaid_debtors | tojson | safe if unpaid_debtors else '[]' }},
                unpaidCreditors: {{ unpaid_creditors | tojson | safe if unpaid_creditors else '[]' }}
            }
        };

        // 4. Form input validation
        document.querySelectorAll('.dashboard-form-control, .dashboard-form-check-input').forEach(input => {
            input.addEventListener('input', () => {
                input.classList.remove('is-invalid');
                const error = input.parentElement.querySelector('.dashboard-text-danger');
                if (error) error.remove();
            });
        });
    });
</script>
{% endblock %}
